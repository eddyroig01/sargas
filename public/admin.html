<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SargaSolutions - Admin Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-black: #0a0a0a;
            --secondary-black: #1a1a1a;
            --tech-gray: #2a2a2a;
            --accent-green: #00ff88;
            --secondary-green: #00cc6a;
            --neon-green: #39ff14;
            --text-white: #ffffff;
            --text-gray: #b0b0b0;
            --text-dark-gray: #666666;
            --border-green: #00ff8844;
            --glow-green: #00ff8822;
            --danger-red: #ff4757;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary-black);
            color: var(--text-white);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Animated Grid Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 136, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            z-index: -1;
            pointer-events: none;
            animation: gridMove 25s linear infinite;
        }
        
        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(30px, 30px); }
        }
        
        /* Login/Register Screen */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-form {
            background: var(--tech-gray);
            border: 2px solid var(--border-green);
            padding: 50px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            clip-path: polygon(20px 0, 100% 0, calc(100% - 20px) 100%, 0 100%);
            position: relative;
            overflow: hidden;
        }
        
        .auth-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-green), var(--neon-green), var(--accent-green));
            animation: scanLine 3s ease-in-out infinite;
        }
        
        @keyframes scanLine {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .auth-title {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 900;
            color: var(--accent-green);
            margin-bottom: 10px;
            text-transform: uppercase;
            text-shadow: 0 0 20px var(--glow-green);
        }
        
        .auth-subtitle {
            color: var(--text-gray);
            margin-bottom: 40px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-green);
        }
        
        .auth-tab {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-gray);
            padding: 15px;
            font-size: 14px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .auth-tab.active {
            color: var(--accent-green);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-green);
        }
        
        .auth-form-content {
            display: none;
        }
        
        .auth-form-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            color: var(--accent-green);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            color: var(--text-white);
            padding: 15px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }
        
        .login-button,
        .register-button {
            width: 100%;
            background: linear-gradient(45deg, var(--accent-green), var(--secondary-green));
            border: none;
            color: var(--primary-black);
            padding: 15px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 100%, 15px 100%);
        }
        
        .login-button:hover,
        .register-button:hover {
            box-shadow: 0 0 25px var(--glow-green);
            transform: translateY(-2px);
        }
        
        .login-button:disabled,
        .register-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .admin-code-info {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--border-green);
            padding: 15px;
            margin-bottom: 20px;
            font-size: 12px;
            color: var(--text-gray);
            text-align: left;
        }
        
        .admin-code-info strong {
            color: var(--accent-green);
        }
        
        /* Dashboard Layout */
        .dashboard {
            display: none;
            min-height: 100vh;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .dashboard-header {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-green);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .dashboard-title {
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            font-weight: 900;
            color: var(--accent-green);
            text-transform: uppercase;
            text-shadow: 0 0 20px var(--glow-green);
        }
        
        .dashboard-nav {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .nav-button {
            background: transparent;
            border: 1px solid var(--border-green);
            color: var(--text-white);
            padding: 10px 20px;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(8px 0, 100% 0, calc(100% - 8px) 100%, 0 100%);
        }
        
        .nav-button:hover,
        .nav-button.active {
            background: var(--accent-green);
            color: var(--primary-black);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }
        
        .logout-button {
            background: linear-gradient(45deg, var(--danger-red), #ff3742);
            border: none;
            color: white;
            padding: 10px 20px;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-button:hover {
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.3);
        }
        
        .dashboard-content {
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }
        
        .stat-card {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--secondary-green));
        }
        
        .stat-card:hover {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }
        
        .stat-number {
            font-family: 'Orbitron', monospace;
            font-size: 48px;
            font-weight: 900;
            color: var(--accent-green);
            margin-bottom: 10px;
            text-shadow: 0 0 15px var(--glow-green);
        }
        
        .stat-label {
            color: var(--text-gray);
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .section-title {
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-white);
            text-transform: uppercase;
        }
        
        .search-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .search-input {
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            color: var(--text-white);
            padding: 10px 15px;
            font-size: 14px;
            width: 250px;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }
        
        .export-button, .refresh-button {
            background: var(--accent-green);
            color: var(--primary-black);
            border: none;
            padding: 10px 20px;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .export-button:hover, .refresh-button:hover {
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
            transform: translateY(-1px);
        }
        
        .data-table {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
            overflow: hidden;
        }
        
        .data-table thead {
            background: var(--secondary-black);
        }
        
        .data-table th {
            color: var(--accent-green);
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 20px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-green);
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .data-table tbody tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        
        .email-cell {
            color: var(--accent-green);
            font-weight: 500;
        }
        
        .timestamp-cell {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .message-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
        }
        
        .loading::before {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 2px solid var(--border-green);
            border-radius: 50%;
            border-top-color: var(--accent-green);
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background: var(--danger-red);
            color: white;
            padding: 15px;
            text-align: center;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        /* Traffic Analytics Styles */
        .traffic-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .traffic-stat-card {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .traffic-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--neon-green));
        }
        
        .traffic-number {
            font-family: 'Orbitron', monospace;
            font-size: 36px;
            font-weight: 900;
            color: var(--accent-green);
            margin-bottom: 8px;
        }
        
        .traffic-label {
            color: var(--text-gray);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .analytics-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            margin-bottom: 40px;
        }
        
        .world-map-container {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 30px;
            position: relative;
            height: 400px;
        }
        
        .map-header {
            color: var(--accent-green);
            font-family: 'Orbitron', monospace;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .world-map {
            width: 100%;
            height: 350px;
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            position: relative;
            overflow: hidden;
        }
        
        .visitor-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent-green);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { 
                opacity: 0.6;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.5);
            }
        }
        
        .country-list {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 30px;
        }
        
        .country-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
        }
        
        .country-name {
            color: var(--text-white);
            font-size: 14px;
        }
        
        .country-count {
            color: var(--accent-green);
            font-weight: 700;
            font-family: 'Orbitron', monospace;
        }
        
        .analytics-setup {
            background: var(--tech-gray);
            border: 2px solid var(--border-green);
            padding: 40px;
            text-align: center;
            margin: 40px 0;
        }
        
        .setup-title {
            font-family: 'Orbitron', monospace;
            color: var(--accent-green);
            font-size: 20px;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        
        .setup-description {
            color: var(--text-gray);
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .setup-steps {
            text-align: left;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .setup-step {
            color: var(--text-gray);
            margin-bottom: 15px;
            padding-left: 25px;
            position: relative;
        }
        
        .setup-step::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            color: var(--accent-green);
            font-weight: 700;
        }
        
        .setup-step a {
            color: var(--accent-green);
            text-decoration: none;
        }
        
        .setup-step a:hover {
            text-decoration: underline;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 20px;
            }
            
            .dashboard-nav {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .dashboard-content {
                padding: 20px;
            }
            
            .search-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                width: 100%;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Register Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-form">
            <h1 class="auth-title">SargaSolutions</h1>
            <p class="auth-subtitle">Admin Access Portal</p>
            
            <!-- Tabs -->
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Sign In</button>
                <button class="auth-tab" data-tab="register">Register</button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form-content active">
                <form id="loginFormElement">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    
                    <button type="submit" class="login-button" id="loginButton">
                        Access Dashboard
                    </button>
                </form>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="auth-form-content">
                <div class="admin-code-info">
                    <strong>Admin Registration:</strong> You need a valid admin code to create an account. Contact your administrator to obtain the registration code.
                </div>
                
                <form id="registerFormElement">
                    <div class="form-group">
                        <label for="adminCode">Admin Code</label>
                        <input type="text" id="adminCode" placeholder="Enter admin code" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" minlength="6" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" minlength="6" required>
                    </div>
                    
                    <button type="submit" class="register-button" id="registerButton">
                        Create Admin Account
                    </button>
                </form>
            </div>
            
            <div id="authError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <header class="dashboard-header">
            <h1 class="dashboard-title">Admin Dashboard</h1>
            <nav class="dashboard-nav">
                <button class="nav-button active" data-tab="contacts">Contact Forms</button>
                <button class="nav-button" data-tab="newsletter">Newsletter</button>
                <button class="nav-button" data-tab="traffic">Traffic</button>
                <button class="logout-button" id="logoutButton">Logout</button>
            </nav>
        </header>

        <main class="dashboard-content">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="contactCount">-</div>
                    <div class="stat-label">Contact Submissions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="newsletterCount">-</div>
                    <div class="stat-label">Newsletter Subscribers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayCount">-</div>
                    <div class="stat-label">Today's Submissions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalVisitors">-</div>
                    <div class="stat-label">Total Visitors</div>
                </div>
            </div>

            <!-- Contact Forms Tab -->
            <div id="contactsTab" class="tab-content active">
                <div class="section-header">
                    <h2 class="section-title">Contact Form Submissions</h2>
                    <div class="search-container">
                        <input type="text" class="search-input" id="contactSearch" placeholder="Search contacts...">
                        <button class="export-button" onclick="exportContacts()">Export CSV</button>
                    </div>
                </div>
                
                <div id="contactsLoading" class="loading">Loading contact submissions...</div>
                <div id="contactsError" class="error-message" style="display: none;"></div>
                
                <table class="data-table" id="contactsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Organization</th>
                            <th>Interest</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody id="contactsTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Newsletter Tab -->
            <div id="newsletterTab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Newsletter Subscriptions</h2>
                    <div class="search-container">
                        <input type="text" class="search-input" id="newsletterSearch" placeholder="Search subscribers...">
                        <button class="export-button" onclick="exportNewsletter()">Export CSV</button>
                    </div>
                </div>
                
                <div id="newsletterLoading" class="loading">Loading newsletter subscriptions...</div>
                <div id="newsletterError" class="error-message" style="display: none;"></div>
                
                <table class="data-table" id="newsletterTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Email</th>
                            <th>Source</th>
                            <th>User Agent</th>
                        </tr>
                    </thead>
                    <tbody id="newsletterTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Traffic Tab -->
            <div id="trafficTab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Website Traffic Analytics</h2>
                    <div class="search-container">
                        <button class="refresh-button" onclick="refreshAnalytics()">🔄 Refresh Analytics</button>
                    </div>
                </div>

                <!-- Analytics Setup Notice (shown only when not configured) -->
                <div id="analyticsSetup" class="analytics-setup">
                    <h3 class="setup-title">🚀 Setup Required: Google Analytics Integration</h3>
                    <p class="setup-description">
                        To view real traffic analytics with Caribbean region focus, follow these steps to integrate Google Analytics with your Firebase Functions.
                    </p>
                    
                    <div class="setup-steps">
                        <div class="setup-step" data-step="1.">
                            Create Google Analytics 4 property at <a href="https://analytics.google.com" target="_blank">analytics.google.com</a> for sargas.ai
                        </div>
                        <div class="setup-step" data-step="2.">
                            Add GA4 tracking code to your main website's index.html
                        </div>
                        <div class="setup-step" data-step="3.">
                            Enable Google Analytics Reporting API in your Firebase project's Google Cloud Console
                        </div>
                        <div class="setup-step" data-step="4.">
                            Create service account credentials and add them to Firebase Functions configuration
                        </div>
                        <div class="setup-step" data-step="5.">
                            Deploy the Firebase Functions (analytics code provided separately)
                        </div>
                        <div class="setup-step" data-step="6.">
                            Configure your GA4 property ID in the Firebase Functions environment
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding: 20px; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--border-green);">
                        <strong style="color: var(--accent-green);">Caribbean Analytics Focus:</strong>
                        <p style="color: var(--text-gray); margin-top: 10px; font-size: 14px;">
                            The system will prioritize and highlight visitors from Caribbean countries including Jamaica, Barbados, 
                            Trinidad & Tobago, Dominican Republic, Puerto Rico, and other regional markets with enhanced visualization.
                        </p>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="refresh-button" onclick="testAnalyticsConnection()">🧪 Test Analytics Connection</button>
                    </div>
                </div>

                <!-- Traffic Statistics -->
                <div id="trafficStats" class="traffic-stats" style="display: none;">
                    <div class="traffic-stat-card">
                        <div class="traffic-number" id="todayVisitors">-</div>
                        <div class="traffic-label">Today's Visitors</div>
                    </div>
                    <div class="traffic-stat-card">
                        <div class="traffic-number" id="weekVisitors">-</div>
                        <div class="traffic-label">This Week</div>
                    </div>
                    <div class="traffic-stat-card">
                        <div class="traffic-number" id="monthVisitors">-</div>
                        <div class="traffic-label">This Month</div>
                    </div>
                    <div class="traffic-stat-card">
                        <div class="traffic-number" id="totalUniqueVisitors">-</div>
                        <div class="traffic-label">Total Unique</div>
                    </div>
                </div>

                <!-- Analytics Container -->
                <div id="analyticsContainer" class="analytics-container" style="display: none;">
                    <!-- World Map -->
                    <div class="world-map-container">
                        <div class="map-header">◆ Global Visitor Map ◆</div>
                        <div class="world-map" id="worldMap">
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-gray);">
                                <div style="text-align: center;">
                                    <div style="font-size: 48px; margin-bottom: 10px;">🌍</div>
                                    <div>Loading analytics data...</div>
                                    <div style="font-size: 12px; margin-top: 5px;">Real visitor locations will appear here</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Country List -->
                    <div class="country-list">
                        <div class="map-header">Visitors by Country</div>
                        <div id="countryListContainer">
                            <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                                <div style="font-size: 24px; margin-bottom: 10px;">📊</div>
                                <div>Loading country data...</div>
                                <div style="font-size: 12px; margin-top: 5px;">Caribbean and global traffic stats</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Error -->
                <div id="analyticsError" class="error-message" style="display: none;"></div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, orderBy, onSnapshot, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // Firebase configuration (same as your main site)
        const firebaseConfig = {
            apiKey: "AIzaSyBtJCbeevb1rXYT76Tu0uNSo3Tj_GkoKz8",
            authDomain: "sargasolutions-webbpage.firebaseapp.com",
            projectId: "sargasolutions-webbpage",
            storageBucket: "sargasolutions-webbpage.firebasestorage.app",
            messagingSenderId: "301093678831",
            appId: "1:301093678831:web:b60d26f1b0f6041f9a751a",
            measurementId: "G-85ESTBJQ5G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app, 'sargasolutions-db');
        const auth = getAuth(app);
        const functions = getFunctions(app);

        // Firebase Functions
        const getAnalyticsData = httpsCallable(functions, 'getAnalyticsData');
        const testAnalytics = httpsCallable(functions, 'testAnalytics');

        // Global variables
        let contactsData = [];
        let newsletterData = [];
        let contactsUnsubscribe = null;
        let newsletterUnsubscribe = null;
        let trafficData = null;
        let analyticsInitialized = false;
        let analyticsRefreshInterval = null;
        
        // Admin code (in production, this should be stored securely on the server)
        const ADMIN_CODE = 'SARGAS21-25';

        // DOM elements
        const authScreen = document.getElementById('authScreen');
        const dashboard = document.getElementById('dashboard');
        const loginFormElement = document.getElementById('loginFormElement');
        const registerFormElement = document.getElementById('registerFormElement');
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const authError = document.getElementById('authError');
        const logoutButton = document.getElementById('logoutButton');

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('User signed in:', user.email);
                showDashboard();
                loadDashboardData();
            } else {
                console.log('User signed out');
                showAuth();
                cleanupListeners();
            }
        });

        // Tab switching for auth forms
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                switchAuthTab(tabName);
            });
        });

        // Login form handler
        loginFormElement.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            loginButton.textContent = 'Signing In...';
            loginButton.disabled = true;
            authError.style.display = 'none';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                authError.textContent = getErrorMessage(error);
                authError.style.display = 'block';
                loginButton.textContent = 'Access Dashboard';
                loginButton.disabled = false;
            }
        });

        // Register form handler
        registerFormElement.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const adminCode = document.getElementById('adminCode').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate admin code
            if (adminCode !== ADMIN_CODE) {
                authError.textContent = 'Invalid admin code. Contact your administrator for the correct code.';
                authError.style.display = 'block';
                return;
            }
            
            // Validate password match
            if (password !== confirmPassword) {
                authError.textContent = 'Passwords do not match.';
                authError.style.display = 'block';
                return;
            }
            
            registerButton.textContent = 'Creating Account...';
            registerButton.disabled = true;
            authError.style.display = 'none';

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // Success - auth state observer will handle the redirect
            } catch (error) {
                console.error('Registration error:', error);
                authError.textContent = getErrorMessage(error);
                authError.style.display = 'block';
                registerButton.textContent = 'Create Admin Account';
                registerButton.disabled = false;
            }
        });

        // Logout handler
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Tab navigation
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                switchTab(tabName);
                
                // Load analytics when traffic tab is activated
                if (tabName === 'traffic') {
                    loadAnalyticsData();
                }
            });
        });

        // Search functionality
        document.getElementById('contactSearch').addEventListener('input', (e) => {
            filterContacts(e.target.value);
        });

        document.getElementById('newsletterSearch').addEventListener('input', (e) => {
            filterNewsletter(e.target.value);
        });

        // Analytics functions
        window.refreshAnalytics = async function() {
            await loadAnalyticsData(true);
        };

        window.testAnalyticsConnection = async function() {
            try {
                const result = await testAnalytics();
                if (result.data.success) {
                    alert('✅ Analytics connection successful! You can now load real traffic data.');
                } else {
                    alert('❌ Analytics connection failed: ' + (result.data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Test failed:', error);
                alert('❌ Analytics test failed: ' + error.message);
            }
        };

        // Show/hide screens
        function showAuth() {
            authScreen.style.display = 'flex';
            dashboard.classList.remove('active');
        }

        function showDashboard() {
            authScreen.style.display = 'none';
            dashboard.classList.add('active');
        }

        // Auth tab switching
        function switchAuthTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update form content
            document.querySelectorAll('.auth-form-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Form`).classList.add('active');
            
            // Clear error message
            authError.style.display = 'none';
        }

        // Error message helper
        function getErrorMessage(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    return 'Invalid email or password';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters';
                case 'auth/invalid-email':
                    return 'Invalid email address';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later';
                default:
                    return 'An error occurred. Please try again';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Update nav buttons
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // Load dashboard data
        function loadDashboardData() {
            loadContacts();
            loadNewsletter();
            // Analytics will be loaded when traffic tab is accessed
        }

        // Load Analytics Data from Firebase Functions
        async function loadAnalyticsData(forceRefresh = false) {
            try {
                console.log('Loading analytics data...');
                
                // Show loading state
                showAnalyticsLoading();
                
                // Call Firebase Function to get analytics data
                const result = await getAnalyticsData();
                
                if (result.data && result.data.success) {
                    console.log('Analytics data received:', result.data.data);
                    
                    const analyticsData = result.data.data;
                    analyticsInitialized = true;
                    
                    // Update UI with real data
                    updateTrafficStats(analyticsData);
                    updateWorldMap(analyticsData.countries);
                    updateCountryList(analyticsData.countries);
                    
                    // Show analytics sections
                    document.getElementById('analyticsSetup').style.display = 'none';
                    document.getElementById('trafficStats').style.display = 'grid';
                    document.getElementById('analyticsContainer').style.display = 'grid';
                    document.getElementById('analyticsError').style.display = 'none';
                    
                    // Update main dashboard stats
                    trafficData = { totalVisitors: analyticsData.totalUsers };
                    updateStats();
                    
                    // Set up auto-refresh (every 5 minutes)
                    if (!analyticsRefreshInterval) {
                        analyticsRefreshInterval = setInterval(() => {
                            loadAnalyticsData();
                        }, 5 * 60 * 1000);
                    }
                    
                } else {
                    throw new Error(result.data ? result.data.error : 'Unknown error');
                }
                
            } catch (error) {
                console.error('Analytics loading failed:', error);
                
                // Show error state
                const errorElement = document.getElementById('analyticsError');
                errorElement.textContent = `Analytics Error: ${error.message}. Please check your Firebase Functions configuration.`;
                errorElement.style.display = 'block';
                
                // Keep setup visible if analytics failed
                document.getElementById('analyticsSetup').style.display = 'block';
                document.getElementById('trafficStats').style.display = 'none';
                document.getElementById('analyticsContainer').style.display = 'none';
            }
        }

        // Show analytics loading state
        function showAnalyticsLoading() {
            const worldMap = document.getElementById('worldMap');
            worldMap.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-gray);">
                    <div style="text-align: center;">
                        <div class="loading" style="font-size: 16px;">Loading analytics data...</div>
                    </div>
                </div>
            `;
            
            const countryList = document.getElementById('countryListContainer');
            countryList.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                    <div class="loading" style="font-size: 14px;">Loading country data...</div>
                </div>
            `;
        }

        // Update traffic statistics with real data
        function updateTrafficStats(analyticsData) {
            document.getElementById('todayVisitors').textContent = analyticsData.today?.users || '-';
            document.getElementById('weekVisitors').textContent = analyticsData.week?.users || '-';
            document.getElementById('monthVisitors').textContent = analyticsData.month?.users || '-';
            document.getElementById('totalUniqueVisitors').textContent = analyticsData.totalUsers || '-';
        }

        // Create world map with real visitor data
        function updateWorldMap(countries) {
            const worldMap = document.getElementById('worldMap');
            
            // Enhanced world map with Caribbean region detail
            const worldMapSVG = `
                <svg viewBox="0 0 800 400" style="width: 100%; height: 100%;">
                    <rect width="800" height="400" fill="${getComputedStyle(document.documentElement).getPropertyValue('--primary-black')}"/>
                    
                    <!-- World continents with more detail for Caribbean -->
                    <!-- North America -->
                    <path d="M 100 80 L 280 70 L 320 100 L 300 140 L 250 160 L 150 150 L 100 120 Z" 
                          fill="#333" stroke="#00ff88" stroke-width="0.5" opacity="0.3"/>
                    
                    <!-- Caribbean Region (enlarged for better visibility) -->
                    <path d="M 220 140 L 280 135 L 290 150 L 275 165 L 240 170 L 220 155 Z" 
                          fill="#444" stroke="#00ff88" stroke-width="1" opacity="0.5"/>
                    
                    <!-- South America -->
                    <path d="M 180 180 L 280 170 L 320 200 L 300 280 L 250 320 L 200 300 L 180 220 Z" 
                          fill="#333" stroke="#00ff88" stroke-width="0.5" opacity="0.3"/>
                    
                    <!-- Europe -->
                    <path d="M 380 80 L 500 75 L 520 100 L 500 130 L 450 140 L 380 120 Z" 
                          fill="#333" stroke="#00ff88" stroke-width="0.5" opacity="0.3"/>
                    
                    <!-- Africa -->
                    <path d="M 380 140 L 480 135 L 500 180 L 480 260 L 420 280 L 380 220 Z" 
                          fill="#333" stroke="#00ff88" stroke-width="0.5" opacity="0.3"/>
                    
                    <!-- Asia -->
                    <path d="M 520 70 L 680 65 L 720 100 L 700 160 L 620 170 L 520 140 Z" 
                          fill="#333" stroke="#00ff88" stroke-width="0.5" opacity="0.3"/>
                    
                    <!-- Australia -->
                    <path d="M 620 280 L 720 275 L 740 300 L 720 320 L 650 325 L 620 305 Z" 
                          fill="#333" stroke="#00ff88" stroke-width="0.5" opacity="0.3"/>
                    
                    <!-- Tech grid overlay -->
                    <defs>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#00ff88" stroke-width="0.2" opacity="0.3"/>
                        </pattern>
                    </defs>
                    <rect width="800" height="400" fill="url(#grid)"/>
                    
                    <!-- Caribbean region highlight -->
                    <circle cx="250" cy="152" r="25" fill="none" stroke="#00ff88" stroke-width="1" opacity="0.7" stroke-dasharray="5,5">
                        <animate attributeName="r" values="25;30;25" dur="3s" repeatCount="indefinite"/>
                    </circle>
                    <text x="250" y="185" text-anchor="middle" fill="#00ff88" font-size="10" opacity="0.8">Caribbean Focus</text>
                </svg>
            `;
            
            worldMap.innerHTML = worldMapSVG;
            
            // Add visitor dots for each country
            if (countries && countries.length > 0) {
                countries.forEach((country, index) => {
                    setTimeout(() => {
                        addVisitorDot(country);
                    }, index * 200);
                });
            } else {
                // Show message when no country data
                setTimeout(() => {
                    const noDataMsg = document.createElement('div');
                    noDataMsg.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        color: var(--text-gray);
                        text-align: center;
                        font-size: 14px;
                    `;
                    noDataMsg.innerHTML = `
                        <div style="font-size: 24px; margin-bottom: 10px;">📊</div>
                        <div>No visitor data yet</div>
                        <div style="font-size: 12px; margin-top: 5px;">Data will appear as visitors come to your site</div>
                    `;
                    worldMap.appendChild(noDataMsg);
                }, 1000);
            }
        }

        // Add visitor dot with real data
        function addVisitorDot(country) {
            const worldMap = document.getElementById('worldMap');
            
            // Convert lat/lng to map coordinates (simple projection)
            const x = ((country.lng + 180) / 360) * 800;
            const y = ((90 - country.lat) / 180) * 400;
            
            const dot = document.createElement('div');
            dot.className = 'visitor-dot';
            dot.style.left = x + 'px';
            dot.style.top = y + 'px';
            dot.title = `${country.name}: ${country.count} visitors`;
            
            // Larger dots for Caribbean countries and higher visitor counts
            const isCaribbean = isCountryInCaribbean(country.name);
            const baseSize = isCaribbean ? 1.5 : 1;
            const size = Math.min(Math.max((country.count / 10) * baseSize, 1), 4);
            dot.style.transform = `scale(${size})`;
            
            // Different color for Caribbean region
            if (isCaribbean) {
                dot.style.background = '#39ff14'; // Brighter green for Caribbean
                dot.style.boxShadow = '0 0 15px #39ff14';
            }
            
            worldMap.appendChild(dot);
        }

        // Check if country is in Caribbean region
        function isCountryInCaribbean(countryName) {
            const caribbeanCountries = [
                'Jamaica', 'Barbados', 'Trinidad and Tobago', 'Dominican Republic',
                'Puerto Rico', 'Cuba', 'Haiti', 'Bahamas', 'Grenada', 'Saint Lucia',
                'Saint Vincent and the Grenadines', 'Antigua and Barbuda', 'Dominica',
                'Saint Kitts and Nevis', 'Martinique', 'Guadeloupe', 'Aruba',
                'Curaçao', 'Sint Maarten', 'British Virgin Islands', 'U.S. Virgin Islands',
                'Cayman Islands', 'Turks and Caicos Islands', 'Anguilla', 'Montserrat'
            ];
            return caribbeanCountries.some(caribbean => 
                countryName.toLowerCase().includes(caribbean.toLowerCase())
            );
        }

        // Update country list with real data
        function updateCountryList(countries) {
            const container = document.getElementById('countryListContainer');
            container.innerHTML = '';
            
            if (!countries || countries.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                        <div style="font-size: 24px; margin-bottom: 10px;">🌍</div>
                        <div>No visitor data available</div>
                        <div style="font-size: 12px; margin-top: 5px;">Data will appear once visitors start coming to your site</div>
                    </div>
                `;
                return;
            }
            
            // Sort countries by visitor count, prioritize Caribbean
            const sortedCountries = [...countries].sort((a, b) => {
                const aIsCaribbean = isCountryInCaribbean(a.name);
                const bIsCaribbean = isCountryInCaribbean(b.name);
                
                if (aIsCaribbean && !bIsCaribbean) return -1;
                if (!aIsCaribbean && bIsCaribbean) return 1;
                return b.count - a.count;
            });
            
            sortedCountries.forEach(country => {
                const countryItem = document.createElement('div');
                countryItem.className = 'country-item';
                
                const isCaribbean = isCountryInCaribbean(country.name);
                const flagIcon = isCaribbean ? '🏝️' : '🌍';
                
                countryItem.innerHTML = `
                    <span class="country-name">${flagIcon} ${country.name}</span>
                    <span class="country-count">${country.count}</span>
                `;
                
                if (isCaribbean) {
                    countryItem.style.borderLeft = '3px solid var(--accent-green)';
                    countryItem.style.paddingLeft = '12px';
                }
                
                container.appendChild(countryItem);
            });
        }

        // Load contacts with real-time updates
        function loadContacts() {
            const contactsQuery = query(collection(db, 'contacts'), orderBy('timestamp', 'desc'));
            
            contactsUnsubscribe = onSnapshot(contactsQuery, (snapshot) => {
                contactsData = [];
                snapshot.forEach((doc) => {
                    contactsData.push({ id: doc.id, ...doc.data() });
                });
                
                renderContactsTable(contactsData);
                updateStats();
                
                document.getElementById('contactsLoading').style.display = 'none';
                document.getElementById('contactsTable').style.display = 'table';
            }, (error) => {
                console.error('Error loading contacts:', error);
                document.getElementById('contactsLoading').style.display = 'none';
                document.getElementById('contactsError').style.display = 'block';
                document.getElementById('contactsError').textContent = 'Error loading contact submissions';
            });
        }

        // Load newsletter with real-time updates
        function loadNewsletter() {
            const newsletterQuery = query(collection(db, 'newsletter'), orderBy('timestamp', 'desc'));
            
            newsletterUnsubscribe = onSnapshot(newsletterQuery, (snapshot) => {
                newsletterData = [];
                snapshot.forEach((doc) => {
                    newsletterData.push({ id: doc.id, ...doc.data() });
                });
                
                renderNewsletterTable(newsletterData);
                updateStats();
                
                document.getElementById('newsletterLoading').style.display = 'none';
                document.getElementById('newsletterTable').style.display = 'table';
            }, (error) => {
                console.error('Error loading newsletter:', error);
                document.getElementById('newsletterLoading').style.display = 'none';
                document.getElementById('newsletterError').style.display = 'block';
                document.getElementById('newsletterError').textContent = 'Error loading newsletter subscriptions';
            });
        }

        // Render contacts table
        function renderContactsTable(data) {
            const tbody = document.getElementById('contactsTableBody');
            tbody.innerHTML = '';

            data.forEach(contact => {
                const row = document.createElement('tr');
                const timestamp = contact.timestamp ? contact.timestamp.toDate() : new Date();
                
                row.innerHTML = `
                    <td class="timestamp-cell">${formatDate(timestamp)}</td>
                    <td>${escapeHtml(contact.name || '-')}</td>
                    <td class="email-cell">${escapeHtml(contact.email || '-')}</td>
                    <td>${escapeHtml(contact.organization || '-')}</td>
                    <td>${escapeHtml(contact.interest || '-')}</td>
                    <td class="message-cell" title="${escapeHtml(contact.message || '-')}">${escapeHtml(contact.message || '-')}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Render newsletter table
        function renderNewsletterTable(data) {
            const tbody = document.getElementById('newsletterTableBody');
            tbody.innerHTML = '';

            data.forEach(subscriber => {
                const row = document.createElement('tr');
                const timestamp = subscriber.timestamp ? subscriber.timestamp.toDate() : new Date();
                
                row.innerHTML = `
                    <td class="timestamp-cell">${formatDate(timestamp)}</td>
                    <td class="email-cell">${escapeHtml(subscriber.email || '-')}</td>
                    <td>${escapeHtml(subscriber.source || '-')}</td>
                    <td>${escapeHtml(subscriber.userAgent ? subscriber.userAgent.substring(0, 50) + '...' : '-')}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update statistics
        function updateStats() {
            document.getElementById('contactCount').textContent = contactsData.length;
            document.getElementById('newsletterCount').textContent = newsletterData.length;

            // Calculate today's submissions
            const today = new Date();
            const todayContacts = contactsData.filter(contact => {
                const date = contact.timestamp ? contact.timestamp.toDate() : new Date();
                return date.toDateString() === today.toDateString();
            }).length;

            const todayNewsletter = newsletterData.filter(subscriber => {
                const date = subscriber.timestamp ? subscriber.timestamp.toDate() : new Date();
                return date.toDateString() === today.toDateString();
            }).length;

            document.getElementById('todayCount').textContent = todayContacts + todayNewsletter;
            
            // Update total visitors from Google Analytics (when available)
            if (trafficData && trafficData.totalVisitors) {
                document.getElementById('totalVisitors').textContent = trafficData.totalVisitors;
            } else {
                document.getElementById('totalVisitors').textContent = '-';
            }
        }

        // Filter functions
        function filterContacts(searchTerm) {
            const filtered = contactsData.filter(contact => {
                const searchLower = searchTerm.toLowerCase();
                return (
                    (contact.name || '').toLowerCase().includes(searchLower) ||
                    (contact.email || '').toLowerCase().includes(searchLower) ||
                    (contact.organization || '').toLowerCase().includes(searchLower) ||
                    (contact.interest || '').toLowerCase().includes(searchLower) ||
                    (contact.message || '').toLowerCase().includes(searchLower)
                );
            });
            renderContactsTable(filtered);
        }

        function filterNewsletter(searchTerm) {
            const filtered = newsletterData.filter(subscriber => {
                const searchLower = searchTerm.toLowerCase();
                return (subscriber.email || '').toLowerCase().includes(searchLower);
            });
            renderNewsletterTable(filtered);
        }

        // Export functions
        window.exportContacts = function() {
            exportToCSV(contactsData, 'contacts', ['timestamp', 'name', 'email', 'organization', 'interest', 'message']);
        };

        window.exportNewsletter = function() {
            exportToCSV(newsletterData, 'newsletter', ['timestamp', 'email', 'source']);
        };

        function exportToCSV(data, filename, fields) {
            const headers = fields.map(field => field.charAt(0).toUpperCase() + field.slice(1));
            const csvContent = [
                headers.join(','),
                ...data.map(row => {
                    return fields.map(field => {
                        let value = row[field] || '';
                        if (field === 'timestamp' && value.toDate) {
                            value = formatDate(value.toDate());
                        }
                        return `"${String(value).replace(/"/g, '""')}"`;
                    }).join(',');
                })
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${formatDate(new Date()).replace(/[^\w]/g, '_')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Utility functions
        function formatDate(date) {
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function cleanupListeners() {
            if (contactsUnsubscribe) {
                contactsUnsubscribe();
                contactsUnsubscribe = null;
            }
            if (newsletterUnsubscribe) {
                newsletterUnsubscribe();
                newsletterUnsubscribe = null;
            }
            if (analyticsRefreshInterval) {
                clearInterval(analyticsRefreshInterval);
                analyticsRefreshInterval = null;
            }
        }
    </script>
</body>
</html>