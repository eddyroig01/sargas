<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SargaSolutions - Admin Dashboard</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="Assets/logo.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-black: #0a0a0a;
            --secondary-black: #1a1a1a;
            --tech-gray: #2a2a2a;
            --accent-green: #00ff88;
            --secondary-green: #00cc6a;
            --neon-green: #39ff14;
            --text-white: #ffffff;
            --text-gray: #b0b0b0;
            --text-dark-gray: #666666;
            --border-green: #00ff8844;
            --glow-green: #00ff8822;
            --danger-red: #ff4757;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary-black);
            color: var(--text-white);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Animated Grid Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 136, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            pointer-events: none;
            animation: gridMove 20s linear infinite;
        }
        
        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* Header */
        .header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-green);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            font-weight: 900;
            color: var(--accent-green);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px var(--glow-green);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-email {
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .logout-btn {
            background: linear-gradient(45deg, var(--danger-red), #ff3742);
            border: none;
            color: white;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 100%, 8px 100%);
        }
        
        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
        }

        /* Login/Register Container */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            position: relative;
        }
        
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, var(--glow-green) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--glow-green) 0%, transparent 50%);
            opacity: 0.05;
        }
        
        .auth-box {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 50px;
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .auth-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-green), var(--secondary-green));
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .auth-title {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 900;
            color: var(--accent-green);
            margin-bottom: 10px;
            text-transform: uppercase;
            text-shadow: 0 0 20px var(--glow-green);
        }
        
        .auth-subtitle {
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            color: var(--accent-green);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            color: var(--text-white);
            padding: 15px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
            resize: vertical;
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }
        
        .form-group textarea {
            min-height: 120px;
            font-family: 'Inter', sans-serif;
        }
        
        .auth-button, .newsletter-button {
            width: 100%;
            background: linear-gradient(45deg, var(--accent-green), var(--secondary-green));
            border: none;
            color: var(--primary-black);
            padding: 15px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.4s ease;
            margin-bottom: 20px;
            clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 100%, 10px 100%);
        }
        
        .auth-button:hover, .newsletter-button:hover {
            box-shadow: 0 0 25px var(--glow-green);
            transform: translateY(-2px);
        }
        
        .auth-button:disabled, .newsletter-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .auth-switch {
            text-align: center;
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .auth-switch a {
            color: var(--accent-green);
            text-decoration: none;
            font-weight: 600;
        }
        
        .auth-switch a:hover {
            text-decoration: underline;
        }
        
        .error-message, .success-message {
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }
        
        .error-message {
            background: var(--danger-red);
            color: white;
        }
        
        .success-message {
            background: var(--accent-green);
            color: var(--primary-black);
            font-weight: 600;
        }

        /* Dashboard Container */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px;
        }
        
        /* Dashboard Header */
        .dashboard-header {
            margin-bottom: 40px;
        }
        
        .dashboard-title {
            font-family: 'Orbitron', monospace;
            font-size: 32px;
            font-weight: 900;
            color: var(--text-white);
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .dashboard-subtitle {
            color: var(--text-gray);
            font-size: 16px;
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 40px;
        }
        
        .tabs-nav {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-green);
        }
        
        .tab-button {
            background: transparent;
            border: none;
            color: var(--text-gray);
            padding: 15px 25px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-bottom: 2px solid transparent;
        }
        
        .tab-button.active {
            color: var(--accent-green);
            border-bottom-color: var(--accent-green);
        }
        
        .tab-button:hover {
            color: var(--accent-green);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* ENHANCED: KPI Stats Cards - Single Row Layout */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--secondary-green));
        }
        
        .stat-card.unsubscribed::before {
            background: linear-gradient(90deg, var(--danger-red), #ff3742);
        }
        
        .stat-card:hover {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }
        
        .stat-number {
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            font-weight: 900;
            color: var(--accent-green);
            margin-bottom: 6px;
            text-align: center;
        }
        
        .stat-card.unsubscribed .stat-number {
            color: var(--danger-red);
        }
        
        .stat-label {
            color: var(--text-gray);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            line-height: 1.3;
        }

        /* Newsletter Broadcast Section - REDESIGNED */
        .newsletter-broadcast-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
            margin-bottom: 40px;
        }
        
        .newsletter-email-container {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 0;
            position: relative;
            overflow: hidden;
        }
        
        .newsletter-email-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-green), var(--secondary-green));
        }
        
        .newsletter-email-header {
            background: var(--primary-black);
            padding: 20px;
            border-bottom: 2px solid var(--border-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .newsletter-email-title {
            font-family: 'Orbitron', monospace;
            color: var(--accent-green);
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .send-newsletter-btn {
            background: linear-gradient(45deg, var(--accent-green), var(--secondary-green));
            border: none;
            color: var(--primary-black);
            padding: 12px 25px;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 100%, 8px 100%);
        }
        
        .send-newsletter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        
        .send-newsletter-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Live Email Template */
        .live-email-template {
            background: #0a0a0a;
            color: #ffffff;
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }

        .email-header {
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 2px solid #00ff8844;
            padding: 30px 40px;
            text-align: center;
            position: relative;
        }

        .email-logo {
            font-family: 'Courier New', monospace;
            font-size: 28px;
            font-weight: bold;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .email-tagline {
            color: #b0b0b0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .email-main-content {
            padding: 50px 40px;
            position: relative;
        }

        .email-greeting {
            color: #b0b0b0;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .greeting-name {
            color: #00ff88;
            font-weight: bold;
        }

        .email-badge {
            display: inline-block;
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #0a0a0a;
            padding: 8px 20px;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 30px;
            clip-path: polygon(15px 0, 100% 0, calc(100% - 15px) 100%, 0 100%);
        }

        .email-title {
            font-family: 'Courier New', monospace;
            font-size: 32px;
            font-weight: bold;
            text-transform: uppercase;
            color: #ffffff;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            line-height: 1.1;
        }

        .email-subtitle {
            color: #b0b0b0;
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .email-content {
            color: #b0b0b0;
            font-size: 16px;
            line-height: 1.7;
            margin-bottom: 30px;
        }

        .email-footer {
            background: #1a1a1a;
            border-top: 1px solid #00ff8844;
            padding: 40px;
            text-align: center;
        }

        .footer-content {
            color: #666666;
            font-size: 12px;
            line-height: 1.5;
        }

        /* Editable Fields */
        .editable-field {
            background: transparent;
            border: 2px dashed rgba(0, 255, 136, 0.5);
            padding: 8px;
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            font-weight: inherit;
            width: 100%;
            min-height: 40px;
            transition: all 0.3s ease;
        }

        .editable-field:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
            background: rgba(0, 255, 136, 0.05);
        }

        .editable-field::placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        .editable-textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* Progress Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--tech-gray);
            border: 2px solid var(--accent-green);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            position: relative;
            text-align: center;
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-green), var(--secondary-green));
        }
        
        .modal-title {
            font-family: 'Orbitron', monospace;
            color: var(--accent-green);
            font-size: 20px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 20px;
        }
        
        .progress-bar-container {
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            height: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--secondary-green));
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            color: var(--text-white);
            font-size: 16px;
            margin: 15px 0;
        }
        
        .progress-details {
            color: var(--text-gray);
            font-size: 14px;
            margin-top: 15px;
        }
        
        .close-modal-btn {
            background: linear-gradient(45deg, var(--danger-red), #ff3742);
            border: none;
            color: white;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 100%, 8px 100%);
            margin-top: 20px;
        }
        
        .close-modal-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
        }

        /* ENHANCED: Analytics Container with Better Layout */
        .analytics-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            margin-bottom: 40px;
            min-height: 600px; /* Ensure consistent height */
        }
        
        .analytics-main {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 30px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .analytics-sidebar {
            display: grid;
            gap: 25px;
            grid-template-rows: 1fr 1fr; /* Equal height for both panels */
        }
        
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-green);
        }
        
        .analytics-title {
            font-family: 'Orbitron', monospace;
            color: var(--accent-green);
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .refresh-btn {
            background: linear-gradient(45deg, var(--accent-green), var(--secondary-green));
            border: none;
            color: var(--primary-black);
            padding: 8px 16px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 100%, 6px 100%);
        }
        
        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        /* ENHANCED: Map Container with Expanded Height - NO KPI CARDS */
        .map-container {
            height: 650px; /* Expanded to fill space previously used by KPI cards */
            border: 2px solid var(--accent-green);
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
            flex-shrink: 0;
        }
        
        /* ENHANCED: Map Info Overlay */
        .map-info-overlay {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(42, 42, 42, 0.95);
            border: 1px solid var(--accent-green);
            padding: 12px 16px;
            border-radius: 6px;
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            color: var(--accent-green);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        
        #visitor-map {
            height: 100%;
            width: 100%;
            background: var(--primary-black);
        }
        
        /* Custom Leaflet Styles for bright map with dark UI */
        .leaflet-control-container {
            filter: none;
        }
        
        .leaflet-control-zoom a {
            background: var(--tech-gray) !important;
            color: var(--accent-green) !important;
            border: 1px solid var(--border-green) !important;
        }
        
        .leaflet-control-attribution {
            background: var(--tech-gray) !important;
            color: var(--text-gray) !important;
            border: 1px solid var(--border-green) !important;
        }
        
        .custom-marker {
            background: var(--accent-green);
            border: 2px solid var(--neon-green);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--accent-green), 0 0 30px var(--accent-green);
            animation: markerPulse 2s ease-in-out infinite;
        }
        
        @keyframes markerPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* ENHANCED: Traffic Metrics Chart Section */
        .traffic-chart-section {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 30px;
            margin-top: 40px;
            position: relative;
        }
        
        .traffic-chart-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-green), var(--secondary-green));
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-green);
        }
        
        .chart-title {
            font-family: 'Orbitron', monospace;
            color: var(--accent-green);
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .chart-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .metric-selector {
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            color: var(--text-white);
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .metric-selector:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }
        
        .time-range-display {
            display: flex;
            align-items: center;
        }
        
        .time-range-label {
            background: var(--primary-black);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 6px 12px;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
            border-radius: 3px;
        }
        
        /* FIXED: Chart container with proper positioning for overlays */
        .chart-container {
            height: 400px;
            position: relative;
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            padding: 20px;
        }
        
        #trafficChart {
            max-height: 100%;
        }

        /* ENHANCED: Chart Status Messages */
        .chart-status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            background: rgba(42, 42, 42, 0.95);
            padding: 30px;
            border: 1px solid var(--border-green);
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
        }

        .chart-status-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .chart-status-title {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--accent-green);
        }

        .chart-status-subtitle {
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .chart-status-explanation {
            font-size: 12px;
            color: var(--text-dark-gray);
            line-height: 1.3;
        }

        /* Countries List */
        .countries-panel {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 25px;
        }
        
        .countries-header {
            color: var(--accent-green);
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-green);
            padding-bottom: 10px;
        }
        
        .countries-list {
            display: grid;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .country-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .country-item:hover {
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }
        
        .country-item.caribbean {
            border-left: 4px solid var(--neon-green);
            background: rgba(0, 255, 136, 0.05);
        }
        
        .country-item.has-states {
            border-left: 4px solid var(--accent-green);
        }
        
        .country-name {
            color: var(--text-white);
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        
        .country-flag {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .country-visitors {
            color: var(--accent-green);
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .expand-arrow {
            color: var(--text-gray);
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .country-item.expanded .expand-arrow {
            transform: rotate(180deg);
        }
        
        .state-breakdown {
            display: none;
            margin-top: 8px;
            padding-left: 20px;
            border-left: 2px solid var(--border-green);
        }
        
        .state-breakdown.expanded {
            display: block;
        }
        
        .state-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.2);
            margin-bottom: 4px;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .state-item:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--accent-green);
            transform: translateX(5px);
        }
        
        .state-name {
            color: var(--text-white);
            font-size: 13px;
            font-weight: 400;
            display: flex;
            align-items: center;
        }
        
        .state-visitors {
            color: var(--accent-green);
            font-size: 13px;
            font-weight: 600;
        }
        
        .state-badge {
            background: var(--accent-green);
            color: var(--primary-black);
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 2px;
            margin-left: 8px;
            font-weight: 700;
        }

        /* Traffic Stats Panel */
        .traffic-stats {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 25px;
        }
        
        .traffic-stats-header {
            color: var(--accent-green);
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-green);
            padding-bottom: 10px;
        }
        
        .traffic-metrics {
            display: grid;
            gap: 15px;
        }
        
        .traffic-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
        }
        
        .traffic-metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: var(--text-gray);
            font-size: 13px;
            text-transform: uppercase;
        }
        
        .metric-value {
            color: var(--accent-green);
            font-weight: 700;
            font-family: 'Orbitron', monospace;
        }

        /* Data Tables */
        .data-table-container {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 30px;
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-green);
        }
        
        .table-title {
            font-family: 'Orbitron', monospace;
            color: var(--accent-green);
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .table-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .search-input {
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            color: var(--text-white);
            padding: 8px 15px;
            font-size: 14px;
            width: 250px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }
        
        .export-btn {
            background: linear-gradient(45deg, var(--accent-green), var(--secondary-green));
            border: none;
            color: var(--primary-black);
            padding: 8px 16px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 100%, 6px 100%);
        }
        
        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--primary-black);
            color: var(--accent-green);
            padding: 15px 20px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border-green);
        }
        
        .data-table td {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
            color: var(--text-white);
        }
        
        .data-table tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        
        .timestamp {
            color: var(--text-gray);
            font-size: 12px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }

        .status-unsubscribed {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger-red);
        }

        /* ENHANCED: Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        
        .toast {
            background: var(--tech-gray);
            border: 1px solid var(--accent-green);
            border-left: 4px solid var(--accent-green);
            padding: 15px 20px;
            border-radius: 4px;
            color: var(--text-white);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.4s ease;
            pointer-events: auto;
            position: relative;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast.success {
            border-color: var(--accent-green);
            border-left-color: var(--accent-green);
        }
        
        .toast.success::before {
            content: '✅';
            margin-right: 10px;
        }
        
        .toast.error {
            border-color: var(--danger-red);
            border-left-color: var(--danger-red);
        }
        
        .toast.error::before {
            content: '❌';
            margin-right: 10px;
        }
        
        .toast.info {
            border-color: #4ecdc4;
            border-left-color: #4ecdc4;
        }
        
        .toast.info::before {
            content: 'ℹ️';
            margin-right: 10px;
        }
        
        .toast-close {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }
        
        .toast-close:hover {
            color: var(--text-white);
        }
        
        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-green);
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            padding: 40px;
        }
        
        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 20px;
            }
            
            .analytics-container, .newsletter-broadcast-container {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .analytics-sidebar {
                order: -1;
            }
            
            .map-container {
                height: 400px;
            }
            
            .header-container {
                padding: 0 20px;
            }
            
            .auth-container {
                padding: 20px;
            }
            
            .auth-box {
                padding: 30px 25px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
                min-height: 80px;
            }
            
            .stat-number {
                font-size: 20px;
            }
            
            .stat-label {
                font-size: 11px;
            }
            
            .table-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .search-input {
                width: 100%;
            }

            .email-main-content {
                padding: 30px 20px;
            }

            .email-header {
                padding: 20px;
            }

            .email-logo {
                font-size: 24px;
            }

            .email-title {
                font-size: 24px;
            }

            .chart-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .time-range-display {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Register Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1 class="auth-title">SARGAS.AI</h1>
                <p class="auth-subtitle">Administrative Access Portal</p>
            </div>
            
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <form id="loginFormElement">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="auth-button" id="loginButton">
                        Access Dashboard
                    </button>
                </form>
                <div class="auth-switch">
                    Need an account? <a href="#" id="showRegister">Register here</a>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <form id="registerFormElement">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Admin Code</label>
                        <input type="text" id="adminCode" required placeholder="Enter admin access code">
                    </div>
                    <button type="submit" class="auth-button" id="registerButton">
                        Create Account
                    </button>
                </form>
                <div class="auth-switch">
                    Already have an account? <a href="#" id="showLogin">Login here</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">📧 Newsletter Broadcast</h3>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">Preparing to send newsletter...</div>
            <div class="progress-details" id="progressDetails">Initializing broadcast system...</div>
            <button class="close-modal-btn" id="closeModalBtn" style="display: none;" onclick="closeProgressModal()">Close</button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardContainer" class="dashboard-container" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="header-container">
                <div class="logo">SARGAS.AI Admin</div>
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <button class="logout-btn" id="logoutButton">Logout</button>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-header" style="display: none;">
            <h1 class="dashboard-title">Admin Dashboard</h1>
            <p class="dashboard-subtitle">Monitor website activity, manage contacts, and track analytics</p>
        </div>

        <!-- ENHANCED: KPI Stats Cards in Single Row -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalContacts">0</div>
                <div class="stat-label">Total Contacts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeSubscribers">0</div>
                <div class="stat-label">Active Subscribers</div>
            </div>
            <div class="stat-card unsubscribed">
                <div class="stat-number" id="unsubscribedCount">0</div>
                <div class="stat-label">Unsubscribed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalNewsletter">0</div>
                <div class="stat-label">Total Newsletter</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalVisitors">0</div>
                <div class="stat-label">Website Visitors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todaySubmissions">0</div>
                <div class="stat-label">Today's Submissions</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" data-tab="contacts">Contact Forms</button>
                <button class="tab-button" data-tab="newsletter">Newsletter</button>
                <button class="tab-button" data-tab="broadcast">Newsletter Broadcast</button>
                <button class="tab-button" data-tab="traffic">Traffic Analytics</button>
            </div>

            <!-- Contact Forms Tab -->
            <div id="contacts" class="tab-content active">
                <div class="data-table-container">
                    <div class="table-header">
                        <h3 class="table-title">Contact Submissions</h3>
                        <div class="table-controls">
                            <input type="text" class="search-input" id="contactSearch" placeholder="Search contacts...">
                            <button class="export-btn" id="exportContacts">Export CSV</button>
                        </div>
                    </div>
                    <div id="contactsLoading" class="loading">Loading contact submissions...</div>
                    <div id="contactsTable" style="display: none;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Organization</th>
                                    <th>Interest</th>
                                    <th>Message</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="contactsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Newsletter Tab -->
            <div id="newsletter" class="tab-content">
                <div class="data-table-container">
                    <div class="table-header">
                        <h3 class="table-title">Newsletter Subscriptions</h3>
                        <div class="table-controls">
                            <input type="text" class="search-input" id="newsletterSearch" placeholder="Search subscribers...">
                            <button class="export-btn" id="exportNewsletter">Export CSV</button>
                        </div>
                    </div>
                    <div id="newsletterLoading" class="loading">Loading newsletter subscriptions...</div>
                    <div id="newsletterTable" style="display: none;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Source</th>
                                    <th>Status</th>
                                    <th>Date Subscribed</th>
                                    <th>Unsubscribed Date</th>
                                </tr>
                            </thead>
                            <tbody id="newsletterTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Newsletter Broadcast Tab - REDESIGNED -->
            <div id="broadcast" class="tab-content">
                <div class="newsletter-broadcast-container">
                    <!-- Live Email Template -->
                    <div class="newsletter-email-container">
                        <div class="newsletter-email-header">
                            <h3 class="newsletter-email-title">📧 Live Newsletter Editor</h3>
                            <button class="send-newsletter-btn" id="sendNewsletterBtn">📧 Send to All Active Subscribers</button>
                        </div>
                        
                        <div id="newsletterSuccessMessage" class="success-message" style="display: none;"></div>
                        <div id="newsletterErrorMessage" class="error-message" style="display: none;"></div>
                        
                        <!-- Live Email Template with Editable Fields -->
                        <div class="live-email-template">
                            <!-- Email Header -->
                            <div class="email-header">
                                <div class="email-logo">SARGAS.AI</div>
                                <div class="email-tagline">Autonomous Maritime Solutions</div>
                            </div>
                            
                            <!-- Email Content -->
                            <div class="email-main-content">
                                <!-- Personal Greeting -->
                                <p class="email-greeting">
                                    Hello <span class="greeting-name">Subscriber</span>,
                                </p>
                                
                                <!-- Newsletter Badge -->
                                <div class="email-badge">
                                    <input class="editable-field" id="newsletterBadge" placeholder="◆ NEWSLETTER UPDATE ◆" value="◆ NEWSLETTER UPDATE ◆" style="background: transparent; border: none; color: inherit; font-size: inherit; font-weight: inherit; text-transform: uppercase; letter-spacing: 2px;">
                                </div>
                                
                                <!-- Newsletter Title -->
                                <h1 class="email-title">
                                    <input class="editable-field" id="newsletterTitle" placeholder="Your Newsletter Title" style="background: transparent; border: 2px dashed rgba(0, 255, 136, 0.5); color: inherit; font-family: inherit; font-size: inherit; font-weight: inherit; text-transform: uppercase;">
                                </h1>
                                
                                <!-- Newsletter Subtitle -->
                                <p class="email-subtitle">
                                    <input class="editable-field" id="newsletterSubtitle" placeholder="Your newsletter subtitle will appear here" style="background: transparent; border: 2px dashed rgba(0, 255, 136, 0.5); color: inherit; font-family: inherit; font-size: inherit;">
                                </p>
                                
                                <!-- Main Newsletter Content -->
                                <div class="email-content">
                                    <textarea class="editable-field editable-textarea" id="newsletterContent" placeholder="Write your newsletter content here. You can use HTML formatting like <strong>bold</strong>, <em>italic</em>, etc." style="background: transparent; border: 2px dashed rgba(0, 255, 136, 0.5); color: inherit; font-family: inherit; font-size: inherit; white-space: pre-wrap;"></textarea>
                                </div>
                                
                                <!-- Optional Featured Update -->
                                <div style="background: #2a2a2a; border: 1px solid #00ff8844; padding: 25px; margin: 30px 0; position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, #00ff88, #00cc6a);"></div>
                                    <div style="font-family: 'Courier New', monospace; color: #00ff88; font-size: 18px; font-weight: bold; text-transform: uppercase; margin-bottom: 15px;">
                                        <input class="editable-field" id="featuredTitle" placeholder="Featured Update Title (Optional)" style="background: transparent; border: 2px dashed rgba(0, 255, 136, 0.5); color: inherit; font-family: inherit; font-size: inherit; font-weight: inherit; text-transform: uppercase;">
                                    </div>
                                    <div style="color: #b0b0b0; font-size: 16px; line-height: 1.6;">
                                        <textarea class="editable-field" id="featuredContent" placeholder="Special announcement or featured content (Optional)" style="background: transparent; border: 2px dashed rgba(0, 255, 136, 0.5); color: inherit; font-family: inherit; font-size: inherit; min-height: 80px;"></textarea>
                                    </div>
                                </div>
                                
                                <!-- CTA Button -->
                                <div style="text-align: center; margin: 40px 0;">
                                    <div style="margin-bottom: 15px;">
                                        <input class="editable-field" id="ctaText" placeholder="Call-to-Action Button Text (Optional)" style="background: transparent; border: 2px dashed rgba(0, 255, 136, 0.5); color: inherit; font-family: inherit; font-size: 14px; text-align: center; width: 250px;">
                                    </div>
                                    <div>
                                        <input class="editable-field" id="ctaLink" placeholder="https://sargas.ai/..." style="background: transparent; border: 2px dashed rgba(0, 255, 136, 0.5); color: inherit; font-family: inherit; font-size: 12px; text-align: center; width: 300px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Email Footer -->
                            <div class="email-footer">
                                <div class="footer-content">
                                    <p>
                                        You're receiving this email because you subscribed to SARGAS.AI updates.<br>
                                        <a href="#" style="color: #00ff88; text-decoration: none;">Unsubscribe</a> | 
                                        <a href="https://sargas.ai" style="color: #00ff88; text-decoration: none;">Visit Website</a> | 
                                        <a href="mailto:info@sargas.ai" style="color: #00ff88; text-decoration: none;">Contact</a>
                                    </p>
                                    <p style="margin-top: 15px;">
                                        © 2025 SargaSolutions. All rights reserved.<br>
                                        Protecting coastlines through autonomous technology.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Traffic Analytics Tab -->
            <div id="traffic" class="tab-content">
                <div class="analytics-container">
                    <div class="analytics-main">
                        <div class="analytics-header">
                            <h3 class="analytics-title">Global Visitor Map</h3>
                            <button class="refresh-btn" id="refreshAnalytics">Refresh Data</button>
                        </div>
                        
                        <!-- Real Interactive Map - EXPANDED WITHOUT KPI CARDS -->
                        <div class="map-container">
                            <div id="visitor-map"></div>
                            <div class="map-info-overlay">
                                <div>🌍 REAL-TIME VISITOR TRACKING</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-sidebar">
                        <!-- Countries Panel -->
                        <div class="countries-panel">
                            <div class="countries-header">Visitor Countries</div>
                            <div id="countriesList" class="countries-list">
                                <div class="loading">Loading countries data...</div>
                            </div>
                        </div>
                        
                        <!-- Traffic Stats Panel -->
                        <div class="traffic-stats">
                            <div class="traffic-stats-header">Traffic Metrics</div>
                            <div class="traffic-metrics">
                                <div class="traffic-metric">
                                    <span class="metric-label">Active Visitors</span>
                                    <span class="metric-value" id="activeUsers">0</span>
                                </div>
                                <div class="traffic-metric">
                                    <span class="metric-label">Website Sessions</span>
                                    <span class="metric-value" id="totalSessions">0</span>
                                </div>
                                <div class="traffic-metric">
                                    <span class="metric-label">Page Views</span>
                                    <span class="metric-value" id="pageViews">0</span>
                                </div>
                                <div class="traffic-metric">
                                    <span class="metric-label">Bounce Rate</span>
                                    <span class="metric-value" id="bounceRate">0%</span>
                                </div>
                                <div class="traffic-metric">
                                    <span class="metric-label">Data Source</span>
                                    <span class="metric-value" style="font-size: 11px;" id="dataSource">GA4</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ENHANCED: Traffic Metrics Chart Section -->
                <div class="traffic-chart-section">
                    <div class="chart-header">
                        <h3 class="chart-title">📊 Traffic Metrics Over Time</h3>
                        <div class="chart-controls">
                            <select class="metric-selector" id="metricSelector">
                                <option value="sessions">Website Sessions</option>
                                <option value="users">Unique Visitors</option>
                                <option value="pageViews">Page Views</option>
                                <option value="bounceRate">Bounce Rate (%)</option>
                            </select>
                            <div class="time-range-display">
                                <span class="time-range-label">📊 Last 7 Days</span>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, orderBy, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable, connectFunctionsEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA6dErBbxAXIke0C2EPBN_p_15EjODRzGo",
            authDomain: "sargasolutions-webapp.firebaseapp.com",
            projectId: "sargasolutions-webapp",
            storageBucket: "sargasolutions-webapp.firebasestorage.app",
            messagingSenderId: "832136984572",
            appId: "1:832136984572:web:2a6700a9a8c1d31a6a2479",
            measurementId: "G-W8PX3BFDFH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'us-central1');

        // Global variables
        let map;
        let currentAnalyticsData = null;
        let trafficChart = null;
        let analyticsCache = {
            data: null,
            timestamp: null,
            duration: 30 * 60 * 1000 // 30 minutes cache
        };

        let isLoadingAnalytics = false; // Prevent duplicate requests

        function getCachedAnalytics() {
            const now = Date.now();
            if (analyticsCache.data && 
                analyticsCache.timestamp && 
                (now - analyticsCache.timestamp) < analyticsCache.duration) {
                console.log('📊 Using cached analytics data');
                return analyticsCache.data;
            }
            return null;
        }

        function setCachedAnalytics(data) {
            analyticsCache.data = data;
            analyticsCache.timestamp = Date.now();
            console.log('📊 Cached analytics data for', analyticsCache.duration / 1000 / 60, 'minutes');
        }

        let contactsData = [];
        let newsletterData = [];

        // Admin code for registration
        const ADMIN_CODE = 'SARGAS2025';

        // Newsletter broadcast URL
        const NEWSLETTER_BROADCAST_URL = 'https://us-central1-sargasolutions-webapp.cloudfunctions.net/sendNewsletterBroadcast';


        // FIXED: Initialize Traffic Chart with better error handling
        function initializeTrafficChart() {
            const canvas = document.getElementById('trafficChart');
            if (!canvas) {
                console.error('❌ Canvas element not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('❌ Cannot get 2D context from canvas');
                return;
            }
            
            // Destroy existing chart if it exists
            if (trafficChart) {
                console.log('🧹 Destroying existing chart');
                trafficChart.destroy();
                trafficChart = null;
            }
            
            // Chart.js configuration with dark theme
            Chart.defaults.color = '#b0b0b0';
            Chart.defaults.borderColor = '#00ff8844';
            Chart.defaults.backgroundColor = '#00ff8822';

            trafficChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Website Sessions',
                        data: [],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#00ff88',
                        pointBorderColor: '#39ff14',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#00ff88',
                                font: {
                                    family: 'Orbitron',
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#2a2a2a',
                            titleColor: '#00ff88',
                            bodyColor: '#ffffff',
                            borderColor: '#00ff88',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#00ff8822'
                            },
                            ticks: {
                                color: '#b0b0b0',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: '#00ff8822'
                            },
                            ticks: {
                                color: '#b0b0b0',
                                font: {
                                    family: 'Inter'
                                }
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        point: {
                            hoverBackgroundColor: '#39ff14'
                        }
                    }
                }
            });

            console.log('✅ Traffic chart initialized successfully');
            return trafficChart;
        }

        // ENHANCED: Load real traffic time-series data with comprehensive fallback strategies
        async function loadTrafficTimeSeries(days = 7, metric = 'sessions') {
            try {
                console.log(`📊 Loading real ${metric} data for ${days} ${days === 1 ? 'day (hourly)' : 'days'}...`);
                
                const response = await fetch('https://us-central1-sargasolutions-webapp.cloudfunctions.net/getAnalyticsData', {

                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        includeTimeSeries: true,
                        days: days,
                        metric: metric 
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const analyticsData = await response.json();
                console.log('📊 Analytics response:', analyticsData);

                if (analyticsData.success) {
                    // CASE 1: We have real time-series data from GA4
                    if (analyticsData.timeSeries && analyticsData.timeSeries.length > 0) {
                        console.log('✅ Processing real GA4 time-series data...');
                        return processRealTimeSeriesData(analyticsData.timeSeries, days, metric);
                    }
                    
                    // CASE 2: No time-series, but we have aggregate data - create distributed chart
                    if (analyticsData.traffic && analyticsData.traffic.sessions > 0) {
                        console.log('🔄 Creating distributed chart from GA4 aggregate data...');
                        return createDistributedChartFromAggregate(days, metric, analyticsData);
                    }
                    
                    // CASE 3: We have real-time data - create basic chart
                    if (analyticsData.realTime && analyticsData.realTime.activeUsers > 0) {
                        console.log('🔄 Creating chart from real-time GA4 data...');
                        return createRealTimeChart(days, metric, analyticsData);
                    }
                }

                // CASE 4: API succeeded but no useful data - explain to user
                console.log('ℹ️ GA4 API succeeded but returned no usable data');
                return createExplanatoryChart(days, metric, 'GA4 connected - waiting for data');

            } catch (error) {
                console.warn(`❌ Failed to load GA4 data:`, error);
                return createExplanatoryChart(days, metric, 'GA4 connection failed');
            }
        }

        // Process real GA4 time-series data
        function processRealTimeSeriesData(timeSeries, days, metric) {
            const labels = timeSeries.map(item => {
                if (days === 1) {
                    return item.displayTime || item.hour + ':00';
                } else {
                    // Fix GA4 date format parsing
                    let dateStr = item.date;
                    if (dateStr) {
                        // Handle different GA4 date formats
                        if (dateStr.length === 8) {
                            // Format: YYYYMMDD -> YYYY-MM-DD
                            dateStr = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                        }
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        }
                    }
                    // Fallback to index-based labeling
                    const fallbackDate = new Date();
                    fallbackDate.setDate(fallbackDate.getDate() - (timeSeries.length - timeSeries.indexOf(item) - 1));
                    return fallbackDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            });

            const data = timeSeries.map(item => {
                switch (metric) {
                    case 'sessions': return item.sessions || 0;
                    case 'users': return item.users || 0;
                    case 'pageViews': return item.pageViews || 0;
                    case 'bounceRate': return parseFloat(item.bounceRate) || 0;
                    default: return item.sessions || 0;
                }
            });

            console.log(`✅ Processed ${timeSeries.length} real GA4 data points`);
            return { 
                labels, 
                data, 
                source: 'GA4-real', 
                timeframe: days === 1 ? 'hourly' : 'daily',
                message: '✅ Live GA4 Time-Series Data'
            };
        }

        // Create distributed chart from aggregate GA4 data
        function createDistributedChartFromAggregate(days, metric, analyticsData) {
            const traffic = analyticsData.traffic;
            const baseValue = traffic[metric] || traffic.sessions || 0;
            
            const labels = [];
            const data = [];
            const now = new Date();
            
            if (days === 1) {
                // Distribute across hours of today
                const currentHour = now.getHours();
                const hourlyBase = Math.floor(baseValue / (currentHour + 1));
                
                for (let hour = 0; hour <= currentHour; hour++) {
                    const variance = Math.random() * 0.4 + 0.8; // 80%-120%
                    const hourlyValue = Math.max(0, Math.floor(hourlyBase * variance));
                    
                    const displayHour = hour === 0 ? '12 AM' : 
                                       hour === 12 ? '12 PM' : 
                                       hour > 12 ? `${hour - 12} PM` : `${hour} AM`;
                    labels.push(displayHour);
                    data.push(hourlyValue);
                }
            } else {
                // Distribute across days with proper date formatting
                const dailyBase = Math.floor(baseValue / days);
                
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    // Use consistent date formatting
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    
                    // Recent days get slightly more activity
                    const recencyMultiplier = 1 + (days - i - 1) * 0.1 / days;
                    const variance = Math.random() * 0.6 + 0.7;
                    const dailyValue = Math.max(0, Math.floor(dailyBase * recencyMultiplier * variance));
                    data.push(dailyValue);
                }
            }

            console.log(`📊 Created distributed chart from GA4 aggregate: ${baseValue} total ${metric}`);
            return { 
                labels, 
                data, 
                source: 'GA4-distributed', 
                timeframe: days === 1 ? 'hourly' : 'daily',
                message: '🔄 GA4 Data (Distributed)'
            };
        }

        // Create chart from real-time data when time-series is not available
        function createRealTimeChart(days, metric, analyticsData) {
            const realTimeUsers = analyticsData.realTime.activeUsers || 0;
            const totalSessions = analyticsData.traffic.sessions || 0;
            const totalPageViews = analyticsData.traffic.pageViews || 0;
            const bounceRate = analyticsData.traffic.bounceRate || 0;

            // Create basic data based on available totals
            let baseValue;
            switch (metric) {
                case 'sessions':
                    baseValue = totalSessions || realTimeUsers;
                    break;
                case 'users':
                    baseValue = analyticsData.traffic.users || realTimeUsers;
                    break;
                case 'pageViews':
                    baseValue = totalPageViews || (realTimeUsers * 2);
                    break;
                case 'bounceRate':
                    baseValue = bounceRate || 50;
                    break;
                default:
                    baseValue = totalSessions || realTimeUsers;
            }

            console.log(`📊 Creating real-time chart with base value: ${baseValue}`);

            const labels = [];
            const data = [];
            const now = new Date();
            
            if (days === 1) {
                // For 1-day view, create hourly distribution
                const currentHour = now.getHours();
                
                for (let hour = 0; hour <= currentHour; hour++) {
                    const displayHour = hour === 0 ? '12 AM' : 
                                       hour === 12 ? '12 PM' : 
                                       hour > 12 ? `${hour - 12} PM` : `${hour} AM`;
                    labels.push(displayHour);
                    
                    // Distribute the total value across hours with some variation
                    const hourlyValue = hour === currentHour ? 
                        Math.max(1, Math.floor(baseValue * 0.3)) : // Current hour gets more activity
                        Math.floor((baseValue * 0.7) / Math.max(1, currentHour)) + Math.floor(Math.random() * 3);
                    
                    data.push(Math.max(0, hourlyValue));
                }
            } else {
                // For multi-day view, create daily distribution with fixed date formatting
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    // Use consistent date formatting
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    
                    // Distribute total across days with recent days having more activity
                    const dayMultiplier = i === 0 ? 0.4 : (1 - (i / days)) * 0.6; // Recent days get more
                    const dailyValue = Math.floor(baseValue * dayMultiplier / days) + Math.floor(Math.random() * 3);
                    
                    data.push(Math.max(0, dailyValue));
                }
            }
            
            return { 
                labels, 
                data, 
                source: 'real-time-distributed', 
                timeframe: days === 1 ? 'hourly' : 'daily',
                message: '⚡ Real-time GA4 Data'
            };
        }

        // Create explanatory chart with user message
        function createExplanatoryChart(days, metric, reason) {
            const labels = [];
            const data = [];
            const now = new Date();
            
            if (days === 1) {
                const currentHour = now.getHours();
                for (let hour = 0; hour <= currentHour; hour++) {
                    const displayHour = hour === 0 ? '12 AM' : 
                                       hour === 12 ? '12 PM' : 
                                       hour > 12 ? `${hour - 12} PM` : `${hour} AM`;
                    labels.push(displayHour);
                    data.push(0); // Empty data
                }
            } else {
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    // Use consistent date formatting
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    data.push(0); // Empty data
                }
            }

            console.log(`ℹ️ Created explanatory chart: ${reason}`);
            return { 
                labels, 
                data, 
                source: 'explanatory', 
                timeframe: days === 1 ? 'hourly' : 'daily',
                message: `ℹ️ ${reason}`,
                explanation: days === 1 ? 
                    'GA4 time-series data can take 24-48 hours to appear. Check back tomorrow!' :
                    'Time-series data appears after 24-48 hours of website activity.'
            };
        }

        // FIXED: Update traffic chart with better overlay handling
        async function updateTrafficChart(metric = 'sessions', days = 7) {
            console.log(`📊 Updating chart with ${metric} data for ${days} days...`);
            
            // Get chart container
            const chartContainer = document.querySelector('.chart-container');
            if (!chartContainer) {
                console.error('❌ Chart container not found');
                return;
            }
            
            // Show loading state WITHOUT destroying canvas
            const loadingMessage = days === 1 ? 
                'Loading today\'s hourly traffic data...' : 
                `Loading ${days}-day traffic trends...`;
            
            // Create loading overlay instead of replacing content
            let loadingOverlay = chartContainer.querySelector('.chart-loading-overlay');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'chart-loading-overlay';
                loadingOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(42, 42, 42, 0.95);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    gap: 15px;
                    z-index: 100;
                `;
                chartContainer.appendChild(loadingOverlay);
            }
            
            loadingOverlay.style.display = 'flex';
            loadingOverlay.innerHTML = `
                <div style="font-size: 18px; color: var(--accent-green);">${loadingMessage}</div>
                <div style="font-size: 14px; color: var(--text-gray);">
                    ${days === 1 ? 
                        'Real-time hourly data from Google Analytics 4' : 
                        'Time-series data may take 24-48 hours to populate in new GA4 properties'
                    }
                </div>
                <div style="width: 40px; height: 40px; border: 3px solid var(--border-green); border-top: 3px solid var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            `;
            
            try {
                // Initialize chart if it doesn't exist
                if (!trafficChart) {
                    console.log('📊 Chart not initialized, creating...');
                    initializeTrafficChart();
                }
                
                // Verify chart is ready
                if (!trafficChart) {
                    throw new Error('Failed to initialize chart');
                }
                
                // Load data
                const chartData = await loadTrafficTimeSeries(days, metric);
                
                // Hide loading overlay
                loadingOverlay.style.display = 'none';
                
                // Update chart data
                trafficChart.data.labels = chartData.labels;
                trafficChart.data.datasets[0].data = chartData.data;
                
                // Configure chart styling
                const metricConfig = getMetricConfiguration(metric);
                const sourceConfig = getSourceConfiguration(chartData.source);
                
                trafficChart.data.datasets[0].label = metricConfig.label;
                trafficChart.data.datasets[0].borderColor = sourceConfig.color;
                trafficChart.data.datasets[0].backgroundColor = sourceConfig.bgColor;
                trafficChart.data.datasets[0].pointBackgroundColor = sourceConfig.color;
                
                // Update title - always 7 days
                trafficChart.options.plugins.title = {
                    display: true,
                    text: [`${metricConfig.label} - Last 7 Days`, chartData.message || sourceConfig.message],
                    color: sourceConfig.titleColor,
                    font: {
                        family: 'Orbitron',
                        size: 14
                    },
                    padding: {
                        top: 10,
                        bottom: 20
                    }
                };
                
                // Add explanation for empty/sample data
                if (chartData.source === 'explanatory' && chartData.explanation) {
                    trafficChart.options.plugins.subtitle = {
                        display: true,
                        text: chartData.explanation,
                        color: '#b0b0b0',
                        font: {
                            family: 'Inter',
                            size: 12
                        },
                        padding: {
                            bottom: 10
                        }
                    };
                }
                
                // Update chart
                trafficChart.update('none'); // 'none' for immediate update without animation
                
                console.log(`✅ Chart updated successfully with ${chartData.source} data`);
                
            } catch (error) {
                console.error('❌ Failed to update chart:', error);
                
                // Hide loading overlay
                loadingOverlay.style.display = 'none';
                
                // Show error message as overlay instead of replacing canvas
                let errorOverlay = chartContainer.querySelector('.chart-error-overlay');
                if (!errorOverlay) {
                    errorOverlay = document.createElement('div');
                    errorOverlay.className = 'chart-error-overlay';
                    errorOverlay.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        text-align: center;
                        z-index: 10;
                        background: rgba(42, 42, 42, 0.95);
                        padding: 30px;
                        border: 1px solid var(--border-green);
                        border-radius: 8px;
                        max-width: 400px;
                        width: 90%;
                    `;
                    chartContainer.appendChild(errorOverlay);
                }
                
                errorOverlay.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">📊</div>
                    <div style="font-family: 'Orbitron', monospace; font-size: 18px; margin-bottom: 10px; color: var(--accent-green);">Chart Loading Failed</div>
                    <div style="font-size: 14px; color: var(--text-gray); margin-bottom: 15px; line-height: 1.4;">
                        7-day data may take 24-48 hours to appear in GA4.
                    </div>
                    <div style="font-size: 12px; color: var(--text-dark-gray); line-height: 1.3;">
                        Your other analytics (visitor map, totals) are working fine
                    </div>
                `;
            }
        }

        // Get metric configuration for styling
        function getMetricConfiguration(metric) {
            const configs = {
                sessions: {
                    label: 'Website Sessions',
                    color: '#00ff88',
                    bgColor: 'rgba(0, 255, 136, 0.1)'
                },
                users: {
                    label: 'Unique Visitors',
                    color: '#39ff14',
                    bgColor: 'rgba(57, 255, 20, 0.1)'
                },
                pageViews: {
                    label: 'Page Views',
                    color: '#00cc6a',
                    bgColor: 'rgba(0, 204, 106, 0.1)'
                },
                bounceRate: {
                    label: 'Bounce Rate (%)',
                    color: '#ff6b6b',
                    bgColor: 'rgba(255, 107, 107, 0.1)'
                }
            };
            return configs[metric] || configs.sessions;
        }

        // Get source configuration for styling and messaging
        function getSourceConfiguration(source) {
            const configs = {
                'GA4-real': {
                    color: '#00ff88',
                    bgColor: 'rgba(0, 255, 136, 0.1)',
                    titleColor: '#00ff88',
                    message: '✅ Live GA4 Time-Series Data'
                },
                'GA4-distributed': {
                    color: '#4ecdc4',
                    bgColor: 'rgba(78, 205, 196, 0.1)',
                    titleColor: '#4ecdc4',
                    message: '🔄 GA4 Data (Distributed from Totals)'
                },
                'real-time-distributed': {
                    color: '#39ff14',
                    bgColor: 'rgba(57, 255, 20, 0.1)',
                    titleColor: '#39ff14',
                    message: '⚡ Real-time GA4 Data'
                },
                'explanatory': {
                    color: '#ff6b6b',
                    bgColor: 'rgba(255, 107, 107, 0.1)',
                    titleColor: '#ff6b6b',
                    message: 'ℹ️ Waiting for GA4 Data'
                },
                'fallback': {
                    color: '#ff6b6b',
                    bgColor: 'rgba(255, 107, 107, 0.1)',
                    titleColor: '#ff6b6b',
                    message: '⚠️ Sample Data (GA4 Issue)'
                }
            };
            return configs[source] || configs.explanatory;
        }

        // ENHANCED: Chart control event listeners - SIMPLIFIED TO 7 DAYS ONLY
        document.addEventListener('DOMContentLoaded', function() {
            // Metric selector - always use 7 days
            document.getElementById('metricSelector').addEventListener('change', function(e) {
                const selectedMetric = e.target.value;
                updateTrafficChart(selectedMetric, 7); // Always 7 days
            });
            
            // FIXED: Ensure proper initialization on tab switch
            setTimeout(() => {
                // Initialize chart only when traffic tab is activated
                const trafficTabButton = document.querySelector('[data-tab="traffic"]');
                if (trafficTabButton) {
                    trafficTabButton.addEventListener('click', () => {
                        setTimeout(() => {
                            if (!trafficChart) {
                                console.log('🚀 Initializing chart for traffic tab...');
                                initializeTrafficChart();
                                // Load default data - always 7 days
                                updateTrafficChart('sessions', 7);
                            }
                        }, 100);
                    });
                }
            }, 500);
        });

        // Authentication state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('User signed in:', user.email);
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('dashboardContainer').style.display = 'block';
                document.getElementById('userEmail').textContent = user.email;
                
                // Load dashboard data
                loadDashboardData();
            } else {
                console.log('User signed out');
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('dashboardContainer').style.display = 'none';
            }
        });

        // Auth form handlers
        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const button = document.getElementById('loginButton');
            
            button.textContent = 'Authenticating...';
            button.disabled = true;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideError();
            } catch (error) {
                console.error('Login error:', error);
                showError('Invalid email or password. Please try again.');
            } finally {
                button.textContent = 'Access Dashboard';
                button.disabled = false;
            }
        });

        document.getElementById('registerFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const adminCode = document.getElementById('adminCode').value;
            const button = document.getElementById('registerButton');
            
            if (adminCode !== ADMIN_CODE) {
                showError('Invalid admin code. Contact your administrator.');
                return;
            }
            
            button.textContent = 'Creating Account...';
            button.disabled = true;
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                hideError();
            } catch (error) {
                console.error('Registration error:', error);
                showError(error.message);
            } finally {
                button.textContent = 'Create Account';
                button.disabled = false;
            }
        });

        // Form switching
        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            hideError();
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            hideError();
        });

        // Logout
        document.getElementById('logoutButton').addEventListener('click', () => {
            signOut(auth);
        });

        // Error handling
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Newsletter error/success handling
        function showNewsletterError(message) {
            const errorDiv = document.getElementById('newsletterErrorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            hideNewsletterSuccess();
        }

        function showNewsletterSuccess(message) {
            const successDiv = document.getElementById('newsletterSuccessMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            hideNewsletterError();
        }

        function hideNewsletterError() {
            document.getElementById('newsletterErrorMessage').style.display = 'none';
        }

        function hideNewsletterSuccess() {
            document.getElementById('newsletterSuccessMessage').style.display = 'none';
        }

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');
                
                // Update active button
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                
                // Initialize components based on tab
                if (tabName === 'traffic') {
                    if (!map) {
                        console.log('Traffic tab selected, initializing map...');
                        initializeMap();
                        
                        // If we have analytics data, update the map after initialization
                        if (window.currentAnalyticsData && window.currentAnalyticsData.countries) {
                            setTimeout(() => {
                                console.log('Updating map with existing analytics data...');
                                updateMapMarkers(window.currentAnalyticsData.countries);
                            }, 500);
                        }
                    }
                    
                    // Initialize chart with REAL data - always 7 days
                    if (!trafficChart) {
                        console.log('Initializing traffic chart with real data...');
                        setTimeout(async () => {
                            initializeTrafficChart();
                            await updateTrafficChart('sessions', 7); // Always 7 days
                        }, 100);
                    }
                }
            });
        });

        // FIXED: Newsletter send button event listener
        document.getElementById('sendNewsletterBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const button = document.getElementById('sendNewsletterBtn');
            const originalText = button.textContent;
            
            // Get data from the live template fields
            const newsletterData = {
                title: document.getElementById('newsletterTitle').value.trim(),
                subtitle: document.getElementById('newsletterSubtitle').value.trim(),
                content: document.getElementById('newsletterContent').value.trim(),
                badge: document.getElementById('newsletterBadge').value.trim(),
                featuredTitle: document.getElementById('featuredTitle').value.trim() || '',
                featuredContent: document.getElementById('featuredContent').value.trim() || '',
                ctaText: document.getElementById('ctaText').value.trim() || '',
                ctaLink: document.getElementById('ctaLink').value.trim() || ''
            };

            // Validate required fields
            if (!newsletterData.title || !newsletterData.content) {
                showNewsletterError('Please fill in the Newsletter Title and Content fields');
                return;
            }

            // Show progress modal
            showProgressModal();
            
            button.textContent = 'Sending Newsletter...';
            button.disabled = true;

            try {
                console.log('🚀 Sending newsletter broadcast via Resend...', newsletterData);
                
                // Send to your Firebase Function that uses Resend
                const response = await fetch(NEWSLETTER_BROADCAST_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newsletterData)
                });

                console.log('📧 Newsletter response status:', response.status);
                
                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    console.error('❌ Failed to parse response as JSON:', parseError);
                    const textResponse = await response.text();
                    console.error('📄 Raw response:', textResponse);
                    throw new Error(`Server returned ${response.status}: ${textResponse.substring(0, 200)}`);
                }
                
                console.log('📧 Newsletter broadcast result:', result);

                if (result.success) {
                    updateProgress(100, `✅ Newsletter sent successfully!`, `Sent to ${result.sent} active subscribers. ${result.errors || 0} failed.`);
                    showNewsletterSuccess(`Newsletter sent successfully to ${result.sent} active subscribers!`);
                    
                    // Clear form fields
                    document.getElementById('newsletterTitle').value = '';
                    document.getElementById('newsletterSubtitle').value = '';
                    document.getElementById('newsletterContent').value = '';
                    document.getElementById('featuredTitle').value = '';
                    document.getElementById('featuredContent').value = '';
                    document.getElementById('ctaText').value = '';
                    document.getElementById('ctaLink').value = '';
                    
                    setTimeout(() => {
                        document.getElementById('closeModalBtn').style.display = 'block';
                    }, 2000);
                } else {
                    throw new Error(result.message || result.error || 'Failed to send newsletter');
                }

            } catch (error) {
                console.error('Newsletter broadcast error:', error);
                updateProgress(0, '❌ Failed to send newsletter', error.message);
                showNewsletterError(`Failed to send newsletter: ${error.message}`);
                
                setTimeout(() => {
                    document.getElementById('closeModalBtn').style.display = 'block';
                }, 2000);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        });

        // Progress modal functions
        function showProgressModal() {
            document.getElementById('progressModal').style.display = 'flex';
            document.getElementById('closeModalBtn').style.display = 'none';
            updateProgress(0, 'Preparing to send newsletter...', 'Initializing broadcast system...');
            
            // Simulate progress updates
            setTimeout(() => updateProgress(20, 'Loading active subscribers...', 'Fetching newsletter subscriber list...'), 500);
            setTimeout(() => updateProgress(40, 'Preparing emails...', 'Personalizing content for each subscriber...'), 1000);
            setTimeout(() => updateProgress(60, 'Sending emails...', 'Broadcasting to subscribers (2 second delay between emails)...'), 1500);
            setTimeout(() => updateProgress(80, 'Almost complete...', 'Finishing email delivery...'), 2000);
        }

        function updateProgress(percentage, text, details) {
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressDetails').textContent = details;
        }

        window.closeProgressModal = function() {
            document.getElementById('progressModal').style.display = 'none';
        };

        // Initialize real interactive map
        function initializeMap() {
            if (map) return;
            
            console.log('🗺️ Initializing Leaflet map...');
            
            // Initialize Leaflet map
            map = L.map('visitor-map', {
                center: [25.0, -70.0], // Caribbean focus
                zoom: 3,
                zoomControl: true,
                attributionControl: false
            });

            // Add bright, visible map tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                subdomains: 'abc',
                maxZoom: 18,
                opacity: 1
            }).addTo(map);

            // Add custom controls
            const infoControl = L.control({position: 'topright'});
            infoControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'map-info-control');
                div.style.cssText = `
                    background: var(--tech-gray);
                    border: 1px solid var(--accent-green);
                    padding: 10px;
                    color: var(--text-white);
                    font-family: 'Orbitron', monospace;
                    font-size: 12px;
                    text-align: center;
                `;
                div.innerHTML = 'SARGAS.AI<br>Global Visitor Tracking';
                return div;
            };
            infoControl.addTo(map);

            console.log('✅ Map initialized successfully');
            
            // Load analytics data on map initialization
            loadAnalyticsData();
        }

        // Better country coordinates mapping with accurate locations
        const countryCoordinates = {
            'United States': [39.8283, -98.5795],
            'Canada': [56.1304, -106.3468],
            'Mexico': [23.6345, -102.5528],
            'Brazil': [-14.2350, -51.9253],
            'United Kingdom': [55.3781, -3.4360],
            'Germany': [51.1657, 10.4515],
            'France': [46.2276, 2.2137],
            'Spain': [40.4637, -3.7492],
            'Italy': [41.8719, 12.5674],
            'Japan': [36.2048, 138.2529],
            'China': [35.8617, 104.1954],
            'India': [20.5937, 78.9629],
            'Australia': [-25.2744, 133.7751],
            'Jamaica': [18.1096, -77.2975],
            'Barbados': [13.1939, -59.5432],
            'Trinidad and Tobago': [10.6918, -61.2225],
            'Puerto Rico': [18.2208, -66.5901],
            'Dominican Republic': [18.7357, -70.1627],
            'Cuba': [21.5218, -77.7812],
            'Bahamas': [25.0343, -77.3963],
            'Antigua and Barbuda': [17.0608, -61.7964],
            'Saint Lucia': [13.9094, -60.9789],
            'Grenada': [12.1165, -61.6790],
            'Saint Vincent and the Grenadines': [12.9843, -61.2872],
            'Saint Kitts and Nevis': [17.3578, -62.7830],
            'Dominica': [15.4140, -61.3710],
            'Haiti': [18.9712, -72.2852],
            'Martinique': [14.6415, -61.0242],
            'Guadeloupe': [16.9950, -62.0670],
            'Netherlands': [52.1326, 5.2913],
            'Belgium': [50.5039, 4.4699],
            'Switzerland': [46.8182, 8.2275],
            'Austria': [47.5162, 14.5501],
            'Portugal': [39.3999, -8.2245],
            'Norway': [60.4720, 8.4689],
            'Sweden': [60.1282, 18.6435],
            'Denmark': [56.2639, 9.5018],
            'Finland': [61.9241, 25.7482],
            'Poland': [51.9194, 19.1451],
            'Czech Republic': [49.8175, 15.4730],
            'Hungary': [47.1625, 19.5033],
            'Romania': [45.9432, 24.9668],
            'Bulgaria': [42.7339, 25.4858],
            'Greece': [39.0742, 21.8243],
            'Turkey': [38.9637, 35.2433],
            'Russia': [61.5240, 105.3188],
            'South Korea': [35.9078, 127.7669],
            'Taiwan': [23.6978, 120.9605],
            'Singapore': [1.3521, 103.8198],
            'Thailand': [15.8700, 100.9925],
            'Malaysia': [4.2105, 101.9758],
            'Indonesia': [-0.7893, 113.9213],
            'Philippines': [12.8797, 121.7740],
            'Vietnam': [14.0583, 108.2772],
            'South Africa': [-30.5595, 22.9375],
            'Egypt': [26.0975, 30.0444],
            'Israel': [31.0461, 34.8516],
            'Saudi Arabia': [23.8859, 45.0792],
            'United Arab Emirates': [23.4241, 53.8478],
            'New Zealand': [-40.9006, 174.8860],
            'Argentina': [-38.4161, -63.6167],
            'Chile': [-35.6751, -71.5430],
            'Colombia': [4.5709, -74.2973],
            'Peru': [-9.1900, -75.0152],
            'Venezuela': [6.4238, -66.5897],
            'Ecuador': [-1.8312, -78.1834],
            'Kenya': [-0.0236, 37.9062]
        };

        // US States/Regions coordinates for state-level data
        const stateCoordinates = {
            // United States
            'Alabama': [32.3182, -86.9023],
            'Alaska': [64.0685, -152.2782],
            'Arizona': [34.2744, -111.2847],
            'Arkansas': [34.7519, -92.1313],
            'California': [36.7783, -119.4179],
            'Colorado': [39.5501, -105.7821],
            'Connecticut': [41.5834, -72.7622],
            'Delaware': [39.1612, -75.5264],
            'Florida': [27.7663, -81.6868],
            'Georgia': [32.9866, -83.6487],
            'Hawaii': [21.1098, -157.5311],
            'Idaho': [44.2394, -114.5103],
            'Illinois': [40.3363, -89.0022],
            'Indiana': [39.8647, -86.2604],
            'Iowa': [42.0046, -93.2140],
            'Kansas': [38.5111, -96.8005],
            'Kentucky': [37.6690, -84.6514],
            'Louisiana': [31.1801, -91.8749],
            'Maine': [44.6074, -69.3977],
            'Maryland': [39.0724, -76.7902],
            'Massachusetts': [42.2373, -71.5314],
            'Michigan': [43.3504, -84.5603],
            'Minnesota': [45.7326, -93.9196],
            'Mississippi': [32.7364, -89.6678],
            'Missouri': [38.4623, -92.302],
            'Montana': [47.0527, -110.2148],
            'Nebraska': [41.2405, -98.4842],
            'Nevada': [38.4199, -117.1219],
            'New Hampshire': [43.4108, -71.5653],
            'New Jersey': [40.3140, -74.5089],
            'New Mexico': [34.8375, -106.2371],
            'New York': [42.9538, -75.5268],
            'North Carolina': [35.6411, -79.8431],
            'North Dakota': [47.5362, -99.793],
            'Ohio': [40.3736, -82.7755],
            'Oklahoma': [35.5376, -96.9247],
            'Oregon': [44.5672, -122.1269],
            'Pennsylvania': [40.5773, -77.264],
            'Rhode Island': [41.6762, -71.5562],
            'South Carolina': [33.8191, -80.9066],
            'South Dakota': [44.2853, -99.4632],
            'Tennessee': [35.7449, -86.7489],
            'Texas': [31.1060, -97.6475],
            'Utah': [40.1135, -111.8535],
            'Vermont': [44.0407, -72.7093],
            'Virginia': [37.7680, -78.2057],
            'Washington': [47.3826, -121.0187],
            'West Virginia': [38.4680, -80.9696],
            'Wisconsin': [44.2563, -89.6385],
            'Wyoming': [42.7475, -107.2085],
            'District of Columbia': [38.9072, -77.0369],

            // Canada Provinces/Territories
            'Alberta': [53.9333, -116.5765],
            'British Columbia': [53.7267, -127.6476],
            'Manitoba': [53.7609, -98.8139],
            'New Brunswick': [46.5653, -66.4619],
            'Newfoundland and Labrador': [53.1355, -57.6604],
            'Northwest Territories': [61.2181, -113.5042],
            'Nova Scotia': [44.6820, -63.7443],
            'Nunavut': [70.2998, -83.1076],
            'Ontario': [51.2538, -85.3232],
            'Prince Edward Island': [46.5107, -63.4168],
            'Quebec': [52.9399, -73.5491],
            'Saskatchewan': [52.9399, -106.4509],
            'Yukon': [64.2823, -135.0000],

            // Mexico States (top ones)
            'Mexico City': [19.4326, -99.1332],
            'Jalisco': [20.6767, -103.3475],
            'Nuevo León': [25.5922, -99.9962],
            'Yucatán': [20.7099, -89.0943],
            'Quintana Roo': [19.1817, -87.4647],

            // UK Regions
            'England': [52.3555, -1.1743],
            'Scotland': [56.4907, -4.2026],
            'Wales': [52.1307, -3.7837],
            'Northern Ireland': [54.7877, -6.4923],

            // Caribbean Islands (already covered by country coordinates)
        };

        // Function to get coordinates for country or state
        function getLocationCoordinates(countryName, regionName = null) {
            // If we have a region/state, try to get state coordinates first
            if (regionName && regionName !== 'Unknown' && regionName.trim() !== '') {
                const stateKey = regionName.trim();
                if (stateCoordinates[stateKey]) {
                    console.log(`🎯 Found STATE coordinates for ${regionName}:`, stateCoordinates[stateKey]);
                    return stateCoordinates[stateKey];
                }
            }
            
            // Fallback to country coordinates
            if (countryCoordinates[countryName]) {
                console.log(`🎯 Using COUNTRY coordinates for ${countryName}:`, countryCoordinates[countryName]);
                return countryCoordinates[countryName];
            }
            
            console.warn(`❌ No coordinates found for ${countryName}${regionName ? ` (${regionName})` : ''}`);
            return null;
        }

        // Caribbean countries for highlighting
        const caribbeanCountries = [
            'Jamaica', 'Barbados', 'Trinidad and Tobago', 'Puerto Rico',
            'Dominican Republic', 'Cuba', 'Bahamas', 'Antigua and Barbuda',
            'Saint Lucia', 'Grenada', 'Saint Vincent and the Grenadines',
            'Saint Kitts and Nevis', 'Dominica', 'Haiti', 'Martinique', 'Guadeloupe'
        ];

        // *** FIXED MAP MARKERS FUNCTION WITH STATE SUPPORT ***
        function updateMapMarkers(countries) {
            if (!map) {
                console.log('❌ Map not initialized yet');
                return;
            }
            
            console.log('🗺️ === UPDATING MAP MARKERS WITH STATE SUPPORT ===');
            console.log('Raw countries data received:', countries);
            console.log('Type of countries data:', typeof countries);
            console.log('Is array?', Array.isArray(countries));
            
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    console.log('🧹 Removing existing marker');
                    map.removeLayer(layer);
                }
            });
            
            if (!countries || countries.length === 0) {
                console.log('❌ No countries data to display');
                return;
            }
            
            // Add markers for each location (country or state)
            countries.forEach((location, index) => {
                console.log(`\n--- 🎯 PROCESSING LOCATION ${index + 1} ---`);
                console.log('Raw location object:', location);
                
                // Handle different possible data formats
                const countryName = location.country || location.name || 'Unknown';
                const regionName = location.region || location.state || null;
                const visitors = location.users || location.visitors || location.sessions || 0;
                
                console.log('📍 Country:', countryName);
                console.log('🏛️ Region/State:', regionName || 'Not specified');
                console.log('👥 Visitor count:', visitors);
                
                // Skip if no valid country name or zero visitors
                if (!countryName || countryName === 'Unknown' || visitors === 0) {
                    console.log('❌ Skipping invalid location data:', { countryName, regionName, visitors });
                    return;
                }
                
                // Get coordinates (state first, then country fallback)
                const coords = getLocationCoordinates(countryName, regionName);
                if (!coords) {
                    console.warn(`❌ NO COORDINATES found for: ${countryName}${regionName ? ` (${regionName})` : ''}`);
                    return;
                }
                
                console.log(`✅ Found coordinates:`, coords);
                
                // *** CRITICAL FIX: Validate and parse coordinates properly ***
                if (!Array.isArray(coords) || coords.length !== 2) {
                    console.error(`❌ Invalid coordinates format:`, coords);
                    return;
                }
                
                const lat = parseFloat(coords[0]);
                const lng = parseFloat(coords[1]);
                
                // Additional coordinate validation
                if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    console.error(`❌ Invalid coordinate values: lat=${lat}, lng=${lng}`);
                    return;
                }
                
                console.log(`🎯 CREATING MARKER at: [${lat}, ${lng}]`);
                
                const isCaribbean = caribbeanCountries.includes(countryName);
                const isStateLevel = regionName && regionName !== 'Unknown' && regionName.trim() !== '';
                
                // Create custom marker with proper size and color
                const markerSize = Math.max(20, Math.min(50, visitors * 8)); // Size between 20-50px
                let markerColor = isCaribbean ? '#39ff14' : '#00ff88';
                let borderColor = isCaribbean ? '#00ff88' : '#39ff14';
                
                // Different colors for state-level markers
                if (isStateLevel) {
                    markerColor = isCaribbean ? '#ff6b6b' : '#4ecdc4';
                    borderColor = isCaribbean ? '#39ff14' : '#ff6b6b';
                }
                
                console.log('🎨 Marker styling:', {
                    size: markerSize,
                    color: markerColor,
                    borderColor,
                    isCaribbean,
                    isStateLevel,
                    coordinates: [lat, lng]
                });
                
                const markerIcon = L.divIcon({
                    className: 'custom-visitor-marker-fixed',
                    html: `<div style="
                        width: ${markerSize}px;
                        height: ${markerSize}px;
                        background: ${markerColor};
                        border: 3px solid ${borderColor};
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #0a0a0a;
                        font-weight: bold;
                        font-size: ${visitors > 9 ? '11px' : '13px'};
                        font-family: 'Orbitron', monospace;
                        box-shadow: 0 0 20px ${markerColor}, 0 0 40px ${markerColor};
                        cursor: pointer;
                        z-index: 1000;
                        ${isStateLevel ? 'border-style: dashed;' : ''}
                    ">${visitors}</div>`,
                    iconSize: [markerSize, markerSize],
                    iconAnchor: [markerSize / 2, markerSize / 2]
                });
                
                try {
                    // *** CRITICAL FIX: Use explicit lat/lng values ***
                    const marker = L.marker([lat, lng], { 
                        icon: markerIcon,
                        interactive: true,
                        keyboard: false,
                        zIndexOffset: isStateLevel ? 2000 : 1000, // States appear above countries
                        riseOnHover: true
                    });
                    
                    // Add to map
                    marker.addTo(map);
                    
                    console.log(`✅ SUCCESSFULLY ADDED MARKER for ${countryName}${regionName ? ` (${regionName})` : ''} at [${lat}, ${lng}]`);
                    
                    // Verify the marker's actual position
                    const markerLatLng = marker.getLatLng();
                    console.log(`🔍 Marker actual position: lat=${markerLatLng.lat}, lng=${markerLatLng.lng}`);
                    
                    // Create detailed popup content
                    const countryFlag = getCountryFlag(countryName);
                    const locationDisplay = regionName ? `${regionName}, ${countryName}` : countryName;
                    const locationIcon = isStateLevel ? '🏛️' : '🌍';
                    
                    const popupContent = `
                        <div style="
                            font-family: 'Inter', sans-serif; 
                            text-align: center;
                            background: #2a2a2a;
                            color: #ffffff;
                            padding: 12px;
                            border-radius: 4px;
                            border: 1px solid ${markerColor};
                            min-width: 180px;
                        ">
                            <div style="
                                font-weight: bold; 
                                color: ${markerColor}; 
                                margin-bottom: 10px;
                                font-size: 16px;
                                line-height: 1.3;
                            ">
                                ${locationIcon} ${countryFlag} ${locationDisplay}
                                ${isCaribbean ? ' 🏝️' : ''}
                            </div>
                            <div style="font-size: 18px; margin-bottom: 6px;">
                                <strong>${visitors}</strong> visitor${visitors !== 1 ? 's' : ''}
                            </div>
                            ${location.sessions ? `<div style="font-size: 14px; color: #b0b0b0; margin-bottom: 4px;">${location.sessions} sessions</div>` : ''}
                            ${isStateLevel ? '<div style="font-size: 11px; color: #4ecdc4; margin-top: 6px;">📍 State-Level Data</div>' : ''}
                            ${isCaribbean ? '<div style="font-size: 12px; color: #39ff14; margin-top: 6px;">🎯 Target Market</div>' : ''}
                            <div style="font-size: 9px; color: #666; margin-top: 6px; border-top: 1px solid #444; padding-top: 4px;">
                                ${isStateLevel ? '🏛️ State' : '🌍 Country'} • [${lat.toFixed(3)}, ${lng.toFixed(3)}]
                            </div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    
                } catch (error) {
                    console.error(`❌ Error adding marker:`, error);
                }
            });
            
            console.log('🗺️ === FINISHED UPDATING MAP MARKERS WITH STATE SUPPORT ===\n');
        }

        // Helper function to get country flags
        function getCountryFlag(countryName) {
            const countryFlags = {
                'United States': '🇺🇸',
                'Canada': '🇨🇦',
                'Mexico': '🇲🇽',
                'Brazil': '🇧🇷',
                'United Kingdom': '🇬🇧',
                'Germany': '🇩🇪',
                'France': '🇫🇷',
                'Spain': '🇪🇸',
                'Italy': '🇮🇹',
                'Japan': '🇯🇵',
                'China': '🇨🇳',
                'India': '🇮🇳',
                'Australia': '🇦🇺',
                'Jamaica': '🇯🇲',
                'Barbados': '🇧🇧',
                'Trinidad and Tobago': '🇹🇹',
                'Puerto Rico': '🇵🇷',
                'Dominican Republic': '🇩🇴',
                'Cuba': '🇨🇺',
                'Bahamas': '🇧🇸',
                'Saint Lucia': '🇱🇨',
                'Grenada': '🇬🇩',
                'Netherlands': '🇳🇱',
                'Belgium': '🇧🇪',
                'Switzerland': '🇨🇭',
                'Austria': '🇦🇹',
                'Portugal': '🇵🇹',
                'Norway': '🇳🇴',
                'Sweden': '🇸🇪',
                'Denmark': '🇩🇰',
                'Finland': '🇫🇮',
                'Kenya': '🇰🇪'
            };
            return countryFlags[countryName] || '🏳️';
        }

        // Focus map on specific location (country or state)
        window.focusLocationOnMap = function(countryName, regionName = null) {
            const coords = getLocationCoordinates(countryName, regionName);
            if (coords && map) {
                const zoomLevel = regionName ? 8 : 6; // Zoom closer for states
                map.setView(coords, zoomLevel);
                
                // Find and open popup for this location
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        const popup = layer.getPopup();
                        if (popup) {
                            const content = popup.getContent();
                            const searchText = regionName ? `${regionName}, ${countryName}` : countryName;
                            if (content.includes(searchText)) {
                                layer.openPopup();
                            }
                        }
                    }
                });
            }
        };

       // Load analytics data with caching
        async function loadAnalyticsData() {
            // Prevent multiple simultaneous requests
            if (isLoadingAnalytics) {
                console.log('📊 Already loading analytics, skipping...');
                return;
            }
            
            // Check cache first
            const cached = getCachedAnalytics();
            if (cached) {
                console.log('📊 Using cached analytics data');
                processAnalyticsData(cached);
                return cached;
            }
            
            isLoadingAnalytics = true;
            console.log('📊 Loading fresh analytics data...');
            
            try {
                // Try to get real GA4 data via fetch first (your working method)
                const response = await fetch('https://us-central1-sargasolutions-webapp.cloudfunctions.net/getAnalyticsData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    const analyticsData = await response.json();
                    console.log('📊 Analytics result:', analyticsData);
                    
                    // Cache the successful response
                    setCachedAnalytics(analyticsData);
                    
                    // Store globally for debugging
                    window.currentAnalyticsData = analyticsData;
                    currentAnalyticsData = analyticsData;
                    
                    // Process and display the data
                    if (analyticsData.success) {
                        processAnalyticsData(analyticsData);
                        updateAnalyticsStatus('✅ Real Google Analytics 4 data retrieved successfully');
                    } else {
                        updateAnalyticsStatus('⚠️ Using sample data - GA4 setup in progress');
                    }
                    return analyticsData;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Analytics loading failed:', error);
                updateAnalyticsStatus('❌ Analytics loading failed - Check connection');
                
                // Try to use cached data even if expired
                if (analyticsCache.data) {
                    console.log('📊 Using expired cache as fallback');
                    processAnalyticsData(analyticsCache.data);
                    return analyticsCache.data;
                }
                
                // Fallback to callable function format with exponential backoff
                try {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second delay
                    
                    const getAnalyticsData = httpsCallable(functions, 'getAnalyticsData');
                    const result = await getAnalyticsData();
                    
                    console.log('Fallback analytics result:', result);
                    const analyticsData = result.data || result;
                    
                    // Cache successful fallback response
                    setCachedAnalytics(analyticsData);
                    
                    // Store globally for debugging
                    window.currentAnalyticsData = analyticsData;
                    currentAnalyticsData = analyticsData;
                    
                    if (analyticsData.success) {
                        processAnalyticsData(analyticsData);
                        updateAnalyticsStatus('✅ Analytics data loaded via fallback method');
                    } else {
                        updateAnalyticsStatus('⚠️ Using sample data - GA4 setup in progress');
                    }
                    return analyticsData;
                } catch (fallbackError) {
                    console.error('Fallback also failed:', fallbackError);
                    updateAnalyticsStatus('❌ All analytics methods failed - using cache if available');
                    
                    // Last resort: use any cached data, even if old
                    if (analyticsCache.data) {
                        processAnalyticsData(analyticsCache.data);
                        return analyticsCache.data;
                    }
                }
            } finally {
                isLoadingAnalytics = false;
            }
        }

        function processAnalyticsData(data) {
            console.log('📊 Processing analytics data:', data);
            
            // Store data globally for debugging
            window.currentAnalyticsData = data;
            
            // Update traffic metrics
            if (data.realTime) {
                document.getElementById('activeUsers').textContent = data.realTime.activeUsers || 0;
            }
            
            if (data.traffic) {
                document.getElementById('totalSessions').textContent = data.traffic.sessions || 0;
                document.getElementById('pageViews').textContent = data.traffic.pageViews || 0;
                document.getElementById('bounceRate').textContent = (data.traffic.bounceRate || 0) + '%';
            }
            
            // Update data source
            document.getElementById('dataSource').textContent = data.source === 'google-analytics-4' ? 'GA4 Live' : 'Sample';
            
            // Calculate stats for internal use (removed DOM updates since KPI cards are gone)
            if (data.countries) {
                // Still calculate for internal use if needed
                const totalCountries = new Set(data.countries.map(c => c.country)).size;
                const totalStates = data.countries.filter(c => c.region && c.region !== 'Unknown').length;
                const caribbeanVisitors = data.countries
                    .filter(c => c.isCaribbean)
                    .reduce((sum, c) => sum + (c.users || c.visitors || 0), 0);
                
                // Store values but don't update DOM elements since they're removed
                console.log(`📊 Stats: ${totalCountries} countries, ${totalStates} states, ${caribbeanVisitors} Caribbean visitors`);
            }
            
            // Debug countries data specifically
            console.log('🌍 === COUNTRIES DEBUG ===');
            console.log('Countries in data:', data.countries);
            console.log('Countries length:', data.countries ? data.countries.length : 'undefined');
            console.log('Countries type:', typeof data.countries);
            
            // Update countries list and map
            if (data.countries && data.countries.length > 0) {
                console.log('✅ Found countries data, updating map and list...');
                updateCountriesList(data.countries);
                
                // Initialize map if not already done and we're on traffic tab
                const trafficTab = document.getElementById('traffic');
                if (trafficTab && trafficTab.classList.contains('active') && !map) {
                    console.log('🗺️ Initializing map because traffic tab is active...');
                    initializeMap();
                    // Add slight delay to ensure map is fully initialized
                    setTimeout(() => {
                        updateMapMarkers(data.countries);
                    }, 500);
                } else if (map) {
                    console.log('🗺️ Map already exists, updating markers...');
                    updateMapMarkers(data.countries);
                } else {
                    console.log('🗺️ Traffic tab not active, storing data for later map update');
                }
            } else {
                console.log('❌ No countries data found, showing empty state');
                // Show empty state
                document.getElementById('countriesList').innerHTML = `
                    <div style="text-align: center; color: var(--text-gray); padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">No data</div>
                        <div>No visitor data yet</div>
                        <div style="font-size: 12px; margin-top: 5px;">Check back after some website visits</div>
                    </div>
                `;
                
                // Clear map markers if map exists
                if (map) {
                    map.eachLayer(layer => {
                        if (layer instanceof L.Marker) {
                            map.removeLayer(layer);
                        }
                    });
                }
            }
        }

        // *** NEW GROUPED COUNTRIES LIST FUNCTION ***
        function updateCountriesList(countries) {
            const countriesList = document.getElementById('countriesList');
            
            if (!countries || countries.length === 0) {
                countriesList.innerHTML = `
                    <div style="text-align: center; color: var(--text-gray); padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">No data</div>
                        <div>No visitor data yet</div>
                    </div>
                `;
                return;
            }
            
            const countryFlags = {
                'United States': '🇺🇸',
                'Canada': '🇨🇦',
                'Mexico': '🇲🇽',
                'Brazil': '🇧🇷',
                'United Kingdom': '🇬🇧',
                'Germany': '🇩🇪',
                'France': '🇫🇷',
                'Spain': '🇪🇸',
                'Italy': '🇮🇹',
                'Japan': '🇯🇵',
                'China': '🇨🇳',
                'India': '🇮🇳',
                'Australia': '🇦🇺',
                'Jamaica': '🇯🇲',
                'Barbados': '🇧🇧',
                'Trinidad and Tobago': '🇹🇹',
                'Puerto Rico': '🇵🇷',
                'Dominican Republic': '🇩🇴',
                'Cuba': '🇨🇺',
                'Bahamas': '🇧🇸',
                'Kenya': '🇰🇪'
            };
            
            // Group countries and aggregate states
            const groupedData = {};
            
            countries.forEach(item => {
                const countryName = item.country;
                const regionName = item.region;
                const visitors = item.users || item.visitors || 0;
                
                if (!groupedData[countryName]) {
                    groupedData[countryName] = {
                        country: countryName,
                        totalVisitors: 0,
                        states: [],
                        isCaribbean: caribbeanCountries.includes(countryName)
                    };
                }
                
                groupedData[countryName].totalVisitors += visitors;
                
                if (regionName && regionName !== 'Unknown' && regionName.trim() !== '') {
                    groupedData[countryName].states.push({
                        name: regionName,
                        visitors: visitors,
                        sessions: item.sessions
                    });
                }
            });
            
            // Sort countries: Caribbean first, then by visitor count
            const sortedCountries = Object.values(groupedData).sort((a, b) => {
                if (a.isCaribbean && !b.isCaribbean) return -1;
                if (!a.isCaribbean && b.isCaribbean) return 1;
                return b.totalVisitors - a.totalVisitors;
            });
            
            // Generate HTML
            const html = sortedCountries.map(countryData => {
                const flag = countryFlags[countryData.country] || '🏳️';
                const hasStates = countryData.states.length > 0;
                const countryId = `country-${countryData.country.replace(/\s+/g, '-')}`;
                
                let countryHtml = `
                    <div class="country-item ${countryData.isCaribbean ? 'caribbean' : ''} ${hasStates ? 'has-states' : ''}" 
                         onclick="toggleCountryExpansion('${countryId}', '${countryData.country}')"
                         data-country="${countryData.country}">
                        <div style="display: flex; align-items: center;">
                            <span class="country-flag">${flag}</span>
                            <span class="country-name">
                                ${countryData.country}
                            </span>
                            ${countryData.isCaribbean ? '<span style="margin-left: 8px; color: var(--neon-green); font-size: 12px;">🏝️</span>' : ''}
                        </div>
                        <div class="country-visitors">
                            ${countryData.totalVisitors} visitor${countryData.totalVisitors !== 1 ? 's' : ''}
                            ${hasStates ? '<span class="expand-arrow">▼</span>' : ''}
                        </div>
                    </div>
                `;
                
                // Add states breakdown if available
                if (hasStates) {
                    const statesHtml = countryData.states
                        .sort((a, b) => b.visitors - a.visitors)
                        .map(state => `
                            <div class="state-item" 
                                 onclick="event.stopPropagation(); focusLocationOnMap('${countryData.country}', '${state.name}')">
                                <div class="state-name">
                                    🏛️ ${state.name}
                                </div>
                                <div class="state-visitors">${state.visitors} visitor${state.visitors !== 1 ? 's' : ''}</div>
                            </div>
                        `).join('');
                    
                    countryHtml += `
                        <div class="state-breakdown" id="${countryId}-breakdown">
                            ${statesHtml}
                        </div>
                    `;
                }
                
                return countryHtml;
            }).join('');
            
            countriesList.innerHTML = html;
        }

        // Toggle country expansion function
        window.toggleCountryExpansion = function(countryId, countryName) {
            const countryItem = document.querySelector(`[onclick*="${countryId}"]`);
            const breakdown = document.getElementById(`${countryId}-breakdown`);
            const arrow = countryItem.querySelector('.expand-arrow');
            
            if (breakdown) {
                // Toggle expansion
                const isExpanded = breakdown.classList.contains('expanded');
                
                if (isExpanded) {
                    // Collapse
                    breakdown.classList.remove('expanded');
                    countryItem.classList.remove('expanded');
                    if (arrow) arrow.textContent = '▼';
                } else {
                    // Expand
                    breakdown.classList.add('expanded');
                    countryItem.classList.add('expanded');
                    if (arrow) arrow.textContent = '▲';
                }
            }
            
            // Focus map on country
            focusLocationOnMap(countryName);
        };

        // =============================================================================
        // TOAST NOTIFICATION SYSTEM
        // =============================================================================
        
        function showToast(message, type = 'success', duration = 4000) {
            const toastContainer = document.getElementById('toastContainer');
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                ${message}
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            // Add to container
            toastContainer.appendChild(toast);
            
            // Show toast with animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 400);
            }, duration);
        }
        
        // Enhanced analytics status with toast notifications
        function updateAnalyticsStatus(message, type = 'info') {
            // Show toast instead of updating static text
            showToast(message, type);
        }

        // Refresh analytics data
        document.getElementById('refreshAnalytics').addEventListener('click', () => {
            const button = document.getElementById('refreshAnalytics');
            const originalText = button.textContent;
            
            button.textContent = 'Refreshing...';
            button.disabled = true;
            
            loadAnalyticsData().finally(() => {
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 1000);
            });
        });

        // Load dashboard data
        async function loadDashboardData() {
            await Promise.all([
                loadContacts(),
                loadNewsletter(),
                loadAnalyticsData()
            ]);
            updateTopStats();
        }

        // Load contacts data
        async function loadContacts() {
            try {
                const q = query(collection(db, 'contacts'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                contactsData = [];
                
                querySnapshot.forEach((doc) => {
                    contactsData.push({ id: doc.id, ...doc.data() });
                });
                
                displayContacts(contactsData);
                document.getElementById('contactsLoading').style.display = 'none';
                document.getElementById('contactsTable').style.display = 'block';
            } catch (error) {
                console.error('Error loading contacts:', error);
                document.getElementById('contactsLoading').innerHTML = 'Error loading contacts';
            }
        }

        // Load newsletter data with enhanced tracking
        async function loadNewsletter() {
            try {
                const q = query(collection(db, 'newsletter'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                newsletterData = [];
                
                querySnapshot.forEach((doc) => {
                    newsletterData.push({ id: doc.id, ...doc.data() });
                });
                
                displayNewsletter(newsletterData);
                document.getElementById('newsletterLoading').style.display = 'none';
                document.getElementById('newsletterTable').style.display = 'block';
            } catch (error) {
                console.error('Error loading newsletter:', error);
                document.getElementById('newsletterLoading').innerHTML = 'Error loading newsletter data';
            }
        }

        // Display contacts
        function displayContacts(contacts) {
            const tbody = document.getElementById('contactsTableBody');
            tbody.innerHTML = '';
            
            contacts.forEach(contact => {
                const row = document.createElement('tr');
                const timestamp = contact.timestamp ? new Date(contact.timestamp.toDate()).toLocaleDateString() : 'N/A';
                
                row.innerHTML = `
                    <td>${contact.name || 'N/A'}</td>
                    <td>${contact.email || 'N/A'}</td>
                    <td>${contact.organization || 'N/A'}</td>
                    <td>${contact.interest || 'N/A'}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${contact.message || 'N/A'}">${contact.message || 'N/A'}</td>
                    <td><span class="timestamp">${timestamp}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Enhanced display newsletter with status tracking
        function displayNewsletter(newsletters) {
            const tbody = document.getElementById('newsletterTableBody');
            tbody.innerHTML = '';
            
            newsletters.forEach(newsletter => {
                const row = document.createElement('tr');
                const timestamp = newsletter.timestamp ? new Date(newsletter.timestamp.toDate()).toLocaleDateString() : 'N/A';
                const unsubscribedDate = newsletter.unsubscribedDate ? new Date(newsletter.unsubscribedDate.toDate()).toLocaleDateString() : 'N/A';
                const isUnsubscribed = newsletter.unsubscribed === true;
                
                row.innerHTML = `
                    <td>${newsletter.email || 'N/A'}</td>
                    <td>${newsletter.source || 'website'}</td>
                    <td>
                        <span class="status-badge ${isUnsubscribed ? 'status-unsubscribed' : 'status-active'}">
                            ${isUnsubscribed ? 'UNSUBSCRIBED' : 'ACTIVE'}
                        </span>
                    </td>
                    <td><span class="timestamp">${timestamp}</span></td>
                    <td><span class="timestamp">${isUnsubscribed ? unsubscribedDate : 'N/A'}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Enhanced top stats with unsubscriber tracking
        function updateTopStats() {
            const activeSubscribers = newsletterData.filter(newsletter => !newsletter.unsubscribed).length;
            const unsubscribedCount = newsletterData.filter(newsletter => newsletter.unsubscribed === true).length;
            
            document.getElementById('totalContacts').textContent = contactsData.length;
            document.getElementById('activeSubscribers').textContent = activeSubscribers;
            document.getElementById('unsubscribedCount').textContent = unsubscribedCount;
            document.getElementById('totalNewsletter').textContent = newsletterData.length;
            
            // Calculate today's submissions
            const today = new Date();
            const todaySubmissions = contactsData.filter(contact => {
                if (!contact.timestamp) return false;
                const contactDate = new Date(contact.timestamp.toDate());
                return contactDate.toDateString() === today.toDateString();
            }).length;
            
            document.getElementById('todaySubmissions').textContent = todaySubmissions;
            
            // Update total visitors from analytics
            if (currentAnalyticsData && currentAnalyticsData.traffic) {
                document.getElementById('totalVisitors').textContent = currentAnalyticsData.traffic.users || 0;
            }
        }

        // Search functionality
        document.getElementById('contactSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredContacts = contactsData.filter(contact => 
                (contact.name || '').toLowerCase().includes(searchTerm) ||
                (contact.email || '').toLowerCase().includes(searchTerm) ||
                (contact.organization || '').toLowerCase().includes(searchTerm) ||
                (contact.interest || '').toLowerCase().includes(searchTerm)
            );
            displayContacts(filteredContacts);
        });

        document.getElementById('newsletterSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredNewsletter = newsletterData.filter(newsletter => 
                (newsletter.email || '').toLowerCase().includes(searchTerm)
            );
            displayNewsletter(filteredNewsletter);
        });

        // Export functionality
        document.getElementById('exportContacts').addEventListener('click', () => {
            exportToCSV(contactsData, 'contacts.csv', ['name', 'email', 'organization', 'interest', 'message', 'timestamp']);
        });

        document.getElementById('exportNewsletter').addEventListener('click', () => {
            exportToCSV(newsletterData, 'newsletter.csv', ['email', 'source', 'unsubscribed', 'timestamp', 'unsubscribedDate']);
        });

        function exportToCSV(data, filename, fields) {
            const csvContent = [
                fields.join(','),
                ...data.map(row => 
                    fields.map(field => {
                        let value = row[field] || '';
                        if ((field === 'timestamp' || field === 'unsubscribedDate') && value && value.toDate) {
                            value = new Date(value.toDate()).toLocaleDateString();
                        }
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Make functions globally available
        window.currentAnalyticsData = currentAnalyticsData;
    </script>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>