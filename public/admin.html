<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SargaSolutions - Admin Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-black: #0a0a0a;
            --secondary-black: #1a1a1a;
            --tech-gray: #2a2a2a;
            --accent-green: #00ff88;
            --secondary-green: #00cc6a;
            --neon-green: #39ff14;
            --text-white: #ffffff;
            --text-gray: #b0b0b0;
            --text-dark-gray: #666666;
            --border-green: #00ff8844;
            --glow-green: #00ff8822;
            --danger-red: #ff4757;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary-black);
            color: var(--text-white);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Animated Grid Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 136, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            pointer-events: none;
            animation: gridMove 20s linear infinite;
        }
        
        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* Header */
        .header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-green);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            font-weight: 900;
            color: var(--accent-green);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px var(--glow-green);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-email {
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .logout-btn {
            background: linear-gradient(45deg, var(--danger-red), #ff3742);
            border: none;
            color: white;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 100%, 8px 100%);
        }
        
        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
        }

        /* Login/Register Container */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            position: relative;
        }
        
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, var(--glow-green) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--glow-green) 0%, transparent 50%);
            opacity: 0.05;
        }
        
        .auth-box {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 50px;
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .auth-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-green), var(--secondary-green));
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .auth-title {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 900;
            color: var(--accent-green);
            margin-bottom: 10px;
            text-transform: uppercase;
            text-shadow: 0 0 20px var(--glow-green);
        }
        
        .auth-subtitle {
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            color: var(--accent-green);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            color: var(--text-white);
            padding: 15px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }
        
        .auth-button {
            width: 100%;
            background: linear-gradient(45deg, var(--accent-green), var(--secondary-green));
            border: none;
            color: var(--primary-black);
            padding: 15px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.4s ease;
            margin-bottom: 20px;
            clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 100%, 10px 100%);
        }
        
        .auth-button:hover {
            box-shadow: 0 0 25px var(--glow-green);
            transform: translateY(-2px);
        }
        
        .auth-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .auth-switch {
            text-align: center;
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .auth-switch a {
            color: var(--accent-green);
            text-decoration: none;
            font-weight: 600;
        }
        
        .auth-switch a:hover {
            text-decoration: underline;
        }
        
        .error-message {
            background: var(--danger-red);
            color: white;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }

        /* Dashboard Container */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px;
        }
        
        /* Dashboard Header */
        .dashboard-header {
            margin-bottom: 40px;
        }
        
        .dashboard-title {
            font-family: 'Orbitron', monospace;
            font-size: 32px;
            font-weight: 900;
            color: var(--text-white);
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .dashboard-subtitle {
            color: var(--text-gray);
            font-size: 16px;
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 40px;
        }
        
        .tabs-nav {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-green);
        }
        
        .tab-button {
            background: transparent;
            border: none;
            color: var(--text-gray);
            padding: 15px 25px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-bottom: 2px solid transparent;
        }
        
        .tab-button.active {
            color: var(--accent-green);
            border-bottom-color: var(--accent-green);
        }
        
        .tab-button:hover {
            color: var(--accent-green);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 25px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--secondary-green));
        }
        
        .stat-card:hover {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }
        
        .stat-number {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 900;
            color: var(--accent-green);
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: var(--text-gray);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Traffic Analytics */
        .analytics-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            margin-bottom: 40px;
        }
        
        .analytics-main {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 30px;
            position: relative;
        }
        
        .analytics-sidebar {
            display: grid;
            gap: 25px;
        }
        
        .analytics-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-green);
        }
        
        .analytics-title {
            font-family: 'Orbitron', monospace;
            color: var(--accent-green);
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .refresh-btn {
            background: linear-gradient(45deg, var(--accent-green), var(--secondary-green));
            border: none;
            color: var(--primary-black);
            padding: 8px 16px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 100%, 6px 100%);
        }
        
        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        /* Real Interactive Map */
        .map-container {
            height: 500px;
            border: 2px solid var(--accent-green);
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #visitor-map {
            height: 100%;
            width: 100%;
            background: var(--primary-black);
        }
        
        /* Custom Leaflet Styles for bright map with dark UI */
        .leaflet-control-container {
            filter: none;
        }
        
        .leaflet-control-zoom a {
            background: var(--tech-gray) !important;
            color: var(--accent-green) !important;
            border: 1px solid var(--border-green) !important;
        }
        
        .leaflet-control-attribution {
            background: var(--tech-gray) !important;
            color: var(--text-gray) !important;
            border: 1px solid var(--border-green) !important;
        }
        
        .leaflet-popup-content-wrapper {
            background: var(--tech-gray);
            border: 1px solid var(--accent-green);
            color: var(--text-white);
            font-family: 'Inter', sans-serif;
        }
        
        .leaflet-popup-tip {
            background: var(--tech-gray);
            border: 1px solid var(--accent-green);
        }
        
        .custom-marker {
            background: var(--accent-green);
            border: 2px solid var(--neon-green);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--accent-green), 0 0 30px var(--accent-green);
            animation: markerPulse 2s ease-in-out infinite;
        }
        
        @keyframes markerPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Countries List */
        .countries-panel {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 25px;
        }
        
        .countries-header {
            color: var(--accent-green);
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-green);
            padding-bottom: 10px;
        }
        
        .countries-list {
            display: grid;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .country-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .country-item:hover {
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }
        
        .country-item.caribbean {
            border-left: 4px solid var(--neon-green);
            background: rgba(0, 255, 136, 0.05);
        }
        
        .country-name {
            color: var(--text-white);
            font-weight: 500;
            font-size: 14px;
        }
        
        .country-flag {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .country-visitors {
            color: var(--accent-green);
            font-weight: 700;
            font-size: 14px;
        }

        /* Traffic Stats Panel */
        .traffic-stats {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 25px;
        }
        
        .traffic-stats-header {
            color: var(--accent-green);
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-green);
            padding-bottom: 10px;
        }
        
        .traffic-metrics {
            display: grid;
            gap: 15px;
        }
        
        .traffic-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
        }
        
        .traffic-metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: var(--text-gray);
            font-size: 13px;
            text-transform: uppercase;
        }
        
        .metric-value {
            color: var(--accent-green);
            font-weight: 700;
            font-family: 'Orbitron', monospace;
        }

        /* Data Tables */
        .data-table-container {
            background: var(--tech-gray);
            border: 1px solid var(--border-green);
            padding: 30px;
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-green);
        }
        
        .table-title {
            font-family: 'Orbitron', monospace;
            color: var(--accent-green);
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .table-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .search-input {
            background: var(--primary-black);
            border: 1px solid var(--border-green);
            color: var(--text-white);
            padding: 8px 15px;
            font-size: 14px;
            width: 250px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }
        
        .export-btn {
            background: linear-gradient(45deg, var(--accent-green), var(--secondary-green));
            border: none;
            color: var(--primary-black);
            padding: 8px 16px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 100%, 6px 100%);
        }
        
        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--primary-black);
            color: var(--accent-green);
            padding: 15px 20px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border-green);
        }
        
        .data-table td {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
            color: var(--text-white);
        }
        
        .data-table tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        
        .timestamp {
            color: var(--text-gray);
            font-size: 12px;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-green);
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            padding: 40px;
        }
        
        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 20px;
            }
            
            .analytics-container {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .analytics-sidebar {
                order: -1;
            }
            
            .map-container {
                height: 300px;
            }
            
            .header-container {
                padding: 0 20px;
            }
            
            .auth-container {
                padding: 20px;
            }
            
            .auth-box {
                padding: 30px 25px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .table-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .search-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Register Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1 class="auth-title">SARGAS.AI</h1>
                <p class="auth-subtitle">Administrative Access Portal</p>
            </div>
            
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <form id="loginFormElement">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="auth-button" id="loginButton">
                        Access Dashboard
                    </button>
                </form>
                <div class="auth-switch">
                    Need an account? <a href="#" id="showRegister">Register here</a>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <form id="registerFormElement">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Admin Code</label>
                        <input type="text" id="adminCode" required placeholder="Enter admin access code">
                    </div>
                    <button type="submit" class="auth-button" id="registerButton">
                        Create Account
                    </button>
                </form>
                <div class="auth-switch">
                    Already have an account? <a href="#" id="showLogin">Login here</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardContainer" class="dashboard-container" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="header-container">
                <div class="logo">SARGAS.AI Admin</div>
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <button class="logout-btn" id="logoutButton">Logout</button>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">Admin Dashboard</h1>
            <p class="dashboard-subtitle">Monitor website activity, manage contacts, and track analytics</p>
        </div>

        <!-- Top Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalContacts">0</div>
                <div class="stat-label">Total Contacts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalNewsletter">0</div>
                <div class="stat-label">Newsletter Subscribers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalVisitors">0</div>
                <div class="stat-label">Website Visitors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todaySubmissions">0</div>
                <div class="stat-label">Today's Submissions</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" data-tab="contacts">Contact Forms</button>
                <button class="tab-button" data-tab="newsletter">Newsletter</button>
                <button class="tab-button" data-tab="traffic">Traffic Analytics</button>
            </div>

            <!-- Contact Forms Tab -->
            <div id="contacts" class="tab-content active">
                <div class="data-table-container">
                    <div class="table-header">
                        <h3 class="table-title">Contact Submissions</h3>
                        <div class="table-controls">
                            <input type="text" class="search-input" id="contactSearch" placeholder="Search contacts...">
                            <button class="export-btn" id="exportContacts">Export CSV</button>
                        </div>
                    </div>
                    <div id="contactsLoading" class="loading">Loading contact submissions...</div>
                    <div id="contactsTable" style="display: none;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Organization</th>
                                    <th>Interest</th>
                                    <th>Message</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="contactsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Newsletter Tab -->
            <div id="newsletter" class="tab-content">
                <div class="data-table-container">
                    <div class="table-header">
                        <h3 class="table-title">Newsletter Subscriptions</h3>
                        <div class="table-controls">
                            <input type="text" class="search-input" id="newsletterSearch" placeholder="Search subscribers...">
                            <button class="export-btn" id="exportNewsletter">Export CSV</button>
                        </div>
                    </div>
                    <div id="newsletterLoading" class="loading">Loading newsletter subscriptions...</div>
                    <div id="newsletterTable" style="display: none;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Source</th>
                                    <th>Date Subscribed</th>
                                </tr>
                            </thead>
                            <tbody id="newsletterTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Traffic Analytics Tab -->
            <div id="traffic" class="tab-content">
                <div class="analytics-container">
                    <div class="analytics-main">
                        <div class="analytics-header">
                            <h3 class="analytics-title">üåç Global Visitor Map</h3>
                            <button class="refresh-btn" id="refreshAnalytics">üîÑ Refresh Data</button>
                        </div>
                        
                        <!-- Real Interactive Map -->
                        <div class="map-container">
                            <div id="visitor-map"></div>
                        </div>
                        
                        <div id="analyticsStatus" style="text-align: center; color: var(--text-gray); font-size: 14px; margin-top: 15px;">
                            Real-time analytics from Google Analytics 4
                        </div>
                    </div>
                    
                    <div class="analytics-sidebar">
                        <!-- Countries Panel -->
                        <div class="countries-panel">
                            <div class="countries-header">üåç Visitor Countries</div>
                            <div id="countriesList" class="countries-list">
                                <div class="loading">Loading countries data...</div>
                            </div>
                        </div>
                        
                        <!-- Traffic Stats Panel -->
                        <div class="traffic-stats">
                            <div class="traffic-stats-header">üìä Traffic Metrics</div>
                            <div class="traffic-metrics">
                                <div class="traffic-metric">
                                    <span class="metric-label">Active Visitors</span>
                                    <span class="metric-value" id="activeUsers">0</span>
                                </div>
                                <div class="traffic-metric">
                                    <span class="metric-label">Website Sessions</span>
                                    <span class="metric-value" id="totalSessions">0</span>
                                </div>
                                <div class="traffic-metric">
                                    <span class="metric-label">Page Views</span>
                                    <span class="metric-value" id="pageViews">0</span>
                                </div>
                                <div class="traffic-metric">
                                    <span class="metric-label">Bounce Rate</span>
                                    <span class="metric-value" id="bounceRate">0%</span>
                                </div>
                                <div class="traffic-metric">
                                    <span class="metric-label">Data Source</span>
                                    <span class="metric-value" style="font-size: 11px;" id="dataSource">GA4</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, orderBy, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable, connectFunctionsEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtJCbeevb1rXYT76Tu0uNSo3Tj_GkoKz8",
            authDomain: "sargasolutions-webbpage.firebaseapp.com",
            projectId: "sargasolutions-webbpage",
            storageBucket: "sargasolutions-webbpage.firebasestorage.app",
            messagingSenderId: "301093678831",
            appId: "1:301093678831:web:b60d26f1b0f6041f9a751a",
            measurementId: "G-85ESTBJQ5G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app, 'sargasolutions-db');
        const functions = getFunctions(app, 'us-central1');

        // Global variables
        let map;
        let currentAnalyticsData = null;
        let contactsData = [];
        let newsletterData = [];

        // Admin code for registration
        const ADMIN_CODE = 'SARGAS2025';

        // Authentication state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('User signed in:', user.email);
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('dashboardContainer').style.display = 'block';
                document.getElementById('userEmail').textContent = user.email;
                
                // Load dashboard data
                loadDashboardData();
            } else {
                console.log('User signed out');
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('dashboardContainer').style.display = 'none';
            }
        });

        // Auth form handlers
        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const button = document.getElementById('loginButton');
            
            button.textContent = 'Authenticating...';
            button.disabled = true;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideError();
            } catch (error) {
                console.error('Login error:', error);
                showError('Invalid email or password. Please try again.');
            } finally {
                button.textContent = 'Access Dashboard';
                button.disabled = false;
            }
        });

        document.getElementById('registerFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const adminCode = document.getElementById('adminCode').value;
            const button = document.getElementById('registerButton');
            
            if (adminCode !== ADMIN_CODE) {
                showError('Invalid admin code. Contact your administrator.');
                return;
            }
            
            button.textContent = 'Creating Account...';
            button.disabled = true;
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                hideError();
            } catch (error) {
                console.error('Registration error:', error);
                showError(error.message);
            } finally {
                button.textContent = 'Create Account';
                button.disabled = false;
            }
        });

        // Form switching
        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            hideError();
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            hideError();
        });

        // Logout
        document.getElementById('logoutButton').addEventListener('click', () => {
            signOut(auth);
        });

        // Error handling
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');
                
                // Update active button
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                
                // Initialize map if traffic tab is selected
                if (tabName === 'traffic' && !map) {
                    initializeMap();
                }
            });
        });

        // Initialize real interactive map
        function initializeMap() {
            if (map) return;
            
            // Initialize Leaflet map
            map = L.map('visitor-map', {
                center: [25.0, -70.0], // Caribbean focus
                zoom: 3,
                zoomControl: true,
                attributionControl: false
            });

            // Add bright, visible map tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                subdomains: 'abc',
                maxZoom: 18,
                opacity: 1
            }).addTo(map);

            // Add custom controls
            const infoControl = L.control({position: 'topright'});
            infoControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'map-info-control');
                div.style.cssText = `
                    background: var(--tech-gray);
                    border: 1px solid var(--accent-green);
                    padding: 10px;
                    color: var(--text-white);
                    font-family: 'Orbitron', monospace;
                    font-size: 12px;
                    text-align: center;
                `;
                div.innerHTML = 'üåç SARGAS.AI<br>Global Visitor Tracking';
                return div;
            };
            infoControl.addTo(map);

            // Load analytics data on map initialization
            loadAnalyticsData();
        }

        // Country coordinates mapping
        const countryCoordinates = {
            'United States': [39.8283, -98.5795],
            'Canada': [56.1304, -106.3468],
            'Mexico': [23.6345, -102.5528],
            'Brazil': [-14.2350, -51.9253],
            'United Kingdom': [55.3781, -3.4360],
            'Germany': [51.1657, 10.4515],
            'France': [46.2276, 2.2137],
            'Spain': [40.4637, -3.7492],
            'Italy': [41.8719, 12.5674],
            'Japan': [36.2048, 138.2529],
            'China': [35.8617, 104.1954],
            'India': [20.5937, 78.9629],
            'Australia': [-25.2744, 133.7751],
            'Jamaica': [18.1096, -77.2975],
            'Barbados': [13.1939, -59.5432],
            'Trinidad and Tobago': [10.6918, -61.2225],
            'Puerto Rico': [18.2208, -66.5901],
            'Dominican Republic': [18.7357, -70.1627],
            'Cuba': [21.5218, -77.7812],
            'Bahamas': [25.0343, -77.3963],
            'Antigua and Barbuda': [17.0608, -61.7964],
            'Saint Lucia': [13.9094, -60.9789],
            'Grenada': [12.1165, -61.6790],
            'Saint Vincent and the Grenadines': [12.9843, -61.2872]
        };

        // Caribbean countries for highlighting
        const caribbeanCountries = [
            'Jamaica', 'Barbados', 'Trinidad and Tobago', 'Puerto Rico',
            'Dominican Republic', 'Cuba', 'Bahamas', 'Antigua and Barbuda',
            'Saint Lucia', 'Grenada', 'Saint Vincent and the Grenadines',
            'Saint Kitts and Nevis', 'Dominica', 'Haiti', 'Martinique', 'Guadeloupe'
        ];

        // Load analytics data
        async function loadAnalyticsData() {
            console.log('Loading analytics data...');
            
            try {
                // Try to get real GA4 data via fetch first (your working method)
                const response = await fetch('https://us-central1-sargasolutions-webbpage.cloudfunctions.net/getAnalyticsData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    const analyticsData = await response.json();
                    console.log('Analytics result:', analyticsData);
                    
                    // Store globally for debugging
                    window.currentAnalyticsData = analyticsData;
                    currentAnalyticsData = analyticsData;
                    
                    // Process and display the data
                    if (analyticsData.success) {
                        processAnalyticsData(analyticsData);
                        updateAnalyticsStatus('‚úÖ Real Google Analytics 4 data retrieved successfully');
                    } else {
                        updateAnalyticsStatus('‚ö†Ô∏è Using sample data - GA4 setup in progress');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Analytics loading failed:', error);
                updateAnalyticsStatus('‚ùå Analytics loading failed - Check connection');
                
                // Fallback to callable function format
                try {
                    const getAnalyticsData = httpsCallable(functions, 'getAnalyticsData');
                    const result = await getAnalyticsData();
                    
                    console.log('Fallback analytics result:', result);
                    const analyticsData = result.data || result;
                    
                    // Store globally for debugging
                    window.currentAnalyticsData = analyticsData;
                    currentAnalyticsData = analyticsData;
                    
                    if (analyticsData.success) {
                        processAnalyticsData(analyticsData);
                        updateAnalyticsStatus('‚úÖ Analytics data loaded via fallback method');
                    } else {
                        updateAnalyticsStatus('‚ö†Ô∏è Using sample data - GA4 setup in progress');
                    }
                } catch (fallbackError) {
                    console.error('Fallback also failed:', fallbackError);
                    updateAnalyticsStatus('‚ùå All analytics methods failed');
                }
            }
        }

        function processAnalyticsData(data) {
            console.log('Processing analytics data:', data);
            
            // Store data globally for debugging
            window.currentAnalyticsData = data;
            
            // Update traffic metrics
            if (data.realTime) {
                document.getElementById('activeUsers').textContent = data.realTime.activeUsers || 0;
            }
            
            if (data.traffic) {
                document.getElementById('totalSessions').textContent = data.traffic.sessions || 0;
                document.getElementById('pageViews').textContent = data.traffic.pageViews || 0;
                document.getElementById('bounceRate').textContent = (data.traffic.bounceRate || 0) + '%';
            }
            
            // Update data source
            document.getElementById('dataSource').textContent = data.source === 'google-analytics-4' ? 'GA4 Live' : 'Sample';
            
            // Debug countries data specifically
            console.log('=== COUNTRIES DEBUG ===');
            console.log('Countries in data:', data.countries);
            console.log('Countries length:', data.countries ? data.countries.length : 'undefined');
            console.log('Countries type:', typeof data.countries);
            
            // Update countries list and map
            if (data.countries && data.countries.length > 0) {
                console.log('‚úÖ Found countries data, updating map and list...');
                updateCountriesList(data.countries);
                updateMapMarkers(data.countries);
            } else {
                console.log('‚ùå No countries data found, showing empty state');
                // Show empty state
                document.getElementById('countriesList').innerHTML = `
                    <div style="text-align: center; color: var(--text-gray); padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üåç</div>
                        <div>No visitor data yet</div>
                        <div style="font-size: 12px; margin-top: 5px;">Check back after some website visits</div>
                    </div>
                `;
                
                // Clear map markers
                if (map) {
                    map.eachLayer(layer => {
                        if (layer instanceof L.Marker) {
                            map.removeLayer(layer);
                        }
                    });
                }
            }
        }

        function updateCountriesList(countries) {
            const countriesList = document.getElementById('countriesList');
            
            if (!countries || countries.length === 0) {
                countriesList.innerHTML = `
                    <div style="text-align: center; color: var(--text-gray); padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üåç</div>
                        <div>No visitor data yet</div>
                    </div>
                `;
                return;
            }
            
            const countryFlags = {
                'United States': 'üá∫üá∏',
                'Canada': 'üá®üá¶',
                'Mexico': 'üá≤üáΩ',
                'Brazil': 'üáßüá∑',
                'United Kingdom': 'üá¨üáß',
                'Germany': 'üá©üá™',
                'France': 'üá´üá∑',
                'Spain': 'üá™üá∏',
                'Italy': 'üáÆüáπ',
                'Japan': 'üáØüáµ',
                'China': 'üá®üá≥',
                'India': 'üáÆüá≥',
                'Australia': 'üá¶üá∫',
                'Jamaica': 'üáØüá≤',
                'Barbados': 'üáßüáß',
                'Trinidad and Tobago': 'üáπüáπ',
                'Puerto Rico': 'üáµüá∑',
                'Dominican Republic': 'üá©üá¥',
                'Cuba': 'üá®üá∫',
                'Bahamas': 'üáßüá∏'
            };
            
            const html = countries.map(country => {
                const isCaribbean = caribbeanCountries.includes(country.country);
                const flag = countryFlags[country.country] || 'üè≥Ô∏è';
                
                return `
                    <div class="country-item ${isCaribbean ? 'caribbean' : ''}" onclick="focusCountryOnMap('${country.country}')">
                        <div style="display: flex; align-items: center;">
                            <span class="country-flag">${flag}</span>
                            <span class="country-name">${country.country}</span>
                            ${isCaribbean ? '<span style="margin-left: 8px; color: var(--neon-green); font-size: 12px;">üèùÔ∏è</span>' : ''}
                        </div>
                        <span class="country-visitors">${country.users} visitor${country.users !== 1 ? 's' : ''}</span>
                    </div>
                `;
            }).join('');
            
            countriesList.innerHTML = html;
        }

        function updateMapMarkers(countries) {
            if (!map) return;
            
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            // Add markers for each country
            countries.forEach(country => {
                const coords = countryCoordinates[country.country];
                if (coords) {
                    const isCaribbean = caribbeanCountries.includes(country.country);
                    
                    // Create custom marker
                    const markerIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                            width: ${Math.max(12, country.users * 4)}px;
                            height: ${Math.max(12, country.users * 4)}px;
                            background: ${isCaribbean ? 'var(--neon-green)' : 'var(--accent-green)'};
                            border: 2px solid ${isCaribbean ? 'var(--accent-green)' : 'var(--neon-green)'};
                            border-radius: 50%;
                            box-shadow: 0 0 15px ${isCaribbean ? 'var(--neon-green)' : 'var(--accent-green)'};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: var(--primary-black);
                            font-weight: bold;
                            font-size: ${country.users > 5 ? '10px' : '8px'};
                        ">${country.users}</div>`,
                        iconSize: [Math.max(12, country.users * 4), Math.max(12, country.users * 4)],
                        iconAnchor: [Math.max(6, country.users * 2), Math.max(6, country.users * 2)]
                    });
                    
                    const marker = L.marker(coords, { icon: markerIcon }).addTo(map);
                    
                    // Add popup
                    const popupContent = `
                        <div style="font-family: 'Inter', sans-serif; text-align: center;">
                            <div style="font-weight: bold; color: var(--accent-green); margin-bottom: 5px;">
                                ${country.country} ${isCaribbean ? 'üèùÔ∏è' : ''}
                            </div>
                            <div style="font-size: 14px;">
                                ${country.users} visitor${country.users !== 1 ? 's' : ''}
                            </div>
                            ${country.sessions ? `<div style="font-size: 12px; color: var(--text-gray);">${country.sessions} sessions</div>` : ''}
                            ${isCaribbean ? '<div style="font-size: 11px; color: var(--neon-green); margin-top: 3px;">üéØ Target Market</div>' : ''}
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                }
            });
        }

        // Focus map on specific country
        window.focusCountryOnMap = function(countryName) {
            const coords = countryCoordinates[countryName];
            if (coords && map) {
                map.setView(coords, 6);
                
                // Find and open popup for this country
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        const popup = layer.getPopup();
                        if (popup && popup.getContent().includes(countryName)) {
                            layer.openPopup();
                        }
                    }
                });
            }
        };

        function updateAnalyticsStatus(message) {
            document.getElementById('analyticsStatus').textContent = message;
        }

        // Refresh analytics data
        document.getElementById('refreshAnalytics').addEventListener('click', () => {
            const button = document.getElementById('refreshAnalytics');
            const originalText = button.textContent;
            
            button.textContent = 'üîÑ Refreshing...';
            button.disabled = true;
            
            loadAnalyticsData().finally(() => {
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 1000);
            });
        });

        // Load dashboard data
        async function loadDashboardData() {
            await Promise.all([
                loadContacts(),
                loadNewsletter(),
                loadAnalyticsData()
            ]);
            updateTopStats();
        }

        // Load contacts data
        async function loadContacts() {
            try {
                const q = query(collection(db, 'contacts'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                contactsData = [];
                
                querySnapshot.forEach((doc) => {
                    contactsData.push({ id: doc.id, ...doc.data() });
                });
                
                displayContacts(contactsData);
                document.getElementById('contactsLoading').style.display = 'none';
                document.getElementById('contactsTable').style.display = 'block';
            } catch (error) {
                console.error('Error loading contacts:', error);
                document.getElementById('contactsLoading').innerHTML = 'Error loading contacts';
            }
        }

        // Load newsletter data
        async function loadNewsletter() {
            try {
                const q = query(collection(db, 'newsletter'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                newsletterData = [];
                
                querySnapshot.forEach((doc) => {
                    newsletterData.push({ id: doc.id, ...doc.data() });
                });
                
                displayNewsletter(newsletterData);
                document.getElementById('newsletterLoading').style.display = 'none';
                document.getElementById('newsletterTable').style.display = 'block';
            } catch (error) {
                console.error('Error loading newsletter:', error);
                document.getElementById('newsletterLoading').innerHTML = 'Error loading newsletter data';
            }
        }

        // Display contacts
        function displayContacts(contacts) {
            const tbody = document.getElementById('contactsTableBody');
            tbody.innerHTML = '';
            
            contacts.forEach(contact => {
                const row = document.createElement('tr');
                const timestamp = contact.timestamp ? new Date(contact.timestamp.toDate()).toLocaleDateString() : 'N/A';
                
                row.innerHTML = `
                    <td>${contact.name || 'N/A'}</td>
                    <td>${contact.email || 'N/A'}</td>
                    <td>${contact.organization || 'N/A'}</td>
                    <td>${contact.interest || 'N/A'}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${contact.message || 'N/A'}">${contact.message || 'N/A'}</td>
                    <td><span class="timestamp">${timestamp}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Display newsletter
        function displayNewsletter(newsletters) {
            const tbody = document.getElementById('newsletterTableBody');
            tbody.innerHTML = '';
            
            newsletters.forEach(newsletter => {
                const row = document.createElement('tr');
                const timestamp = newsletter.timestamp ? new Date(newsletter.timestamp.toDate()).toLocaleDateString() : 'N/A';
                
                row.innerHTML = `
                    <td>${newsletter.email || 'N/A'}</td>
                    <td>${newsletter.source || 'website'}</td>
                    <td><span class="timestamp">${timestamp}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update top stats
        function updateTopStats() {
            document.getElementById('totalContacts').textContent = contactsData.length;
            document.getElementById('totalNewsletter').textContent = newsletterData.length;
            
            // Calculate today's submissions
            const today = new Date();
            const todaySubmissions = contactsData.filter(contact => {
                if (!contact.timestamp) return false;
                const contactDate = new Date(contact.timestamp.toDate());
                return contactDate.toDateString() === today.toDateString();
            }).length;
            
            document.getElementById('todaySubmissions').textContent = todaySubmissions;
            
            // Update total visitors from analytics
            if (currentAnalyticsData && currentAnalyticsData.traffic) {
                document.getElementById('totalVisitors').textContent = currentAnalyticsData.traffic.users || 0;
            }
        }

        // Search functionality
        document.getElementById('contactSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredContacts = contactsData.filter(contact => 
                (contact.name || '').toLowerCase().includes(searchTerm) ||
                (contact.email || '').toLowerCase().includes(searchTerm) ||
                (contact.organization || '').toLowerCase().includes(searchTerm) ||
                (contact.interest || '').toLowerCase().includes(searchTerm)
            );
            displayContacts(filteredContacts);
        });

        document.getElementById('newsletterSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredNewsletter = newsletterData.filter(newsletter => 
                (newsletter.email || '').toLowerCase().includes(searchTerm)
            );
            displayNewsletter(filteredNewsletter);
        });

        // Export functionality
        document.getElementById('exportContacts').addEventListener('click', () => {
            exportToCSV(contactsData, 'contacts.csv', ['name', 'email', 'organization', 'interest', 'message', 'timestamp']);
        });

        document.getElementById('exportNewsletter').addEventListener('click', () => {
            exportToCSV(newsletterData, 'newsletter.csv', ['email', 'source', 'timestamp']);
        });

        function exportToCSV(data, filename, fields) {
            const csvContent = [
                fields.join(','),
                ...data.map(row => 
                    fields.map(field => {
                        let value = row[field] || '';
                        if (field === 'timestamp' && value && value.toDate) {
                            value = new Date(value.toDate()).toLocaleDateString();
                        }
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Make functions globally available
        window.currentAnalyticsData = currentAnalyticsData;
    </script>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>